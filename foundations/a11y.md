# 1.2 表单/可访问性（a11y）入门

本章目标：用**语义化结构 + 原生能力 + 最小 ARIA**，做出键盘可达、读屏友好、移动端顺手、验证清晰的表单。示例均为可直接复制的最小实现。

---

## 1) 设计原则

- **原生优先**：优先使用原生控件与浏览器校验（Constraint Validation API）。
- **标签永远可见**：`label` 不等于 `placeholder`，后者仅作补充说明。
- **键盘先行**：保证 Tab/Shift+Tab 顺序合理；保留焦点样式；Enter 提交、Esc 取消/关闭。
- **分组清晰**：相关字段用 `fieldset/legend`；附加提示用 `aria-describedby` 关联。
- **错误前置**：字段旁显示错误，顶部提供“错误汇总”锚点；使用 `aria-live` 宣告。
- **最小 ARIA**：仅在原生语义不足时添加（如 `aria-invalid`、`aria-required`）。
- **移动友好**：设置合适的 `type`、`inputmode`、`autocomplete` 以优化软键盘与自动填充。

---

## 2) 表单基础结构（可直接复用）

```html
<form action="/signup" method="post" novalidate aria-describedby="form-hint">
  <p id="form-hint" class="hint">带 * 为必填；提交后若有错误，将先定位到顶部错误汇总。</p>

  <fieldset>
    <legend>账户信息</legend>

    <div class="field">
      <label for="email">邮箱 *</label>
      <input id="email" name="email" type="email" required
             autocomplete="email" inputmode="email"
             aria-describedby="email-hint email-err" />
      <small id="email-hint" class="hint">用于登录与通知，不会公开。</small>
      <span id="email-err" class="error" aria-live="polite"></span>
    </div>

    <div class="field">
      <label for="pwd">密码 *</label>
      <input id="pwd" name="password" type="password" required minlength="8"
             autocomplete="new-password"
             aria-describedby="pwd-hint pwd-err" />
      <small id="pwd-hint" class="hint">至少 8 位，建议包含字母与数字。</small>
      <span id="pwd-err" class="error" aria-live="polite"></span>
    </div>

    <div class="field">
      <label for="pwd2">确认密码 *</label>
      <input id="pwd2" name="password_confirm" type="password" required
             autocomplete="new-password" aria-describedby="pwd2-err" />
      <span id="pwd2-err" class="error" aria-live="polite"></span>
    </div>
  </fieldset>

  <fieldset>
    <legend>偏好与同意</legend>

    <div class="field">
      <label for="phone">手机号（可选）</label>
      <input id="phone" name="phone" type="tel" inputmode="tel"
             autocomplete="tel" aria-describedby="phone-hint" />
      <small id="phone-hint" class="hint">用于找回账号或二次验证。</small>
    </div>

    <div class="field">
      <input id="agree" name="agree" type="checkbox" required
             aria-describedby="agree-err" />
      <label for="agree">我已阅读并同意服务条款 *</label>
      <span id="agree-err" class="error" aria-live="polite"></span>
    </div>
  </fieldset>

  <div id="error-summary" class="error-summary" tabindex="-1" hidden aria-live="assertive">
    <h2>请修正以下错误</h2>
    <ul></ul>
  </div>

  <div class="actions">
    <button type="submit">创建账户</button>
    <button type="reset">清空</button>
  </div>
</form>
```

**样式基线**（含焦点可见、错误区、仅读屏可见）：

```css
:root { --err:#b91c1c; --hint:#6b7280; --focus:#2563eb; }
* { box-sizing: border-box; }
label { display:block; margin:.5rem 0 .25rem; }
.field { margin:1rem 0; }
.hint { color:var(--hint); font-size:.875rem; }
.error { color:var(--err); display:block; min-height:1.25rem; margin-top:.25rem; }
.error-summary { border:2px solid var(--err); padding:1rem; margin:1rem 0; }
:focus-visible { outline:3px solid var(--focus); outline-offset:2px; }
/* 仅读屏可见 */
.visually-hidden{
  position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;
  overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0;
}
```

**最小增强校验**（Constraint Validation API + 错误汇总）：

```js
const form = document.querySelector('form');
const summary = document.getElementById('error-summary');
const list = summary.querySelector('ul');

form.addEventListener('submit', (e) => {
  list.innerHTML = '';
  summary.hidden = true;

  // 跨字段校验：两次密码一致
  const pwd = form.password;
  const pwd2 = form.password_confirm;
  if (pwd.value && pwd2.value && pwd.value !== pwd2.value) {
    pwd2.setCustomValidity('两次输入的密码不一致');
  } else {
    pwd2.setCustomValidity('');
  }

  if (!form.checkValidity()) {
    e.preventDefault();

    const invalid = form.querySelectorAll(':invalid');
    invalid.forEach(el => {
      el.setAttribute('aria-invalid', 'true');
      const id = el.getAttribute('id');
      const err = document.getElementById(id + '-err');
      if (err) err.textContent = el.validationMessage;

      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = `#${id}`;
      a.textContent = `${el.labels?.[0]?.textContent?.replace('*','').trim()}：${el.validationMessage}`;
      li.appendChild(a);
      list.appendChild(li);
    });

    summary.hidden = false;
    summary.focus();
  }
});

form.addEventListener('input', (e) => {
  const el = e.target;
  if (!(el instanceof HTMLInputElement)) return;
  el.removeAttribute('aria-invalid');
  const err = document.getElementById(el.id + '-err');
  if (err) err.textContent = '';
});
```

---

## 3) 输入类型 / 自动填充 / 移动端优化

| 目标 | 推荐写法 | 说明 |
|---|---|---|
| 邮箱 | `type="email" autocomplete="email" inputmode="email"` | 软键盘含 `@`；密码管家识别。 |
| 手机 | `type="tel" autocomplete="tel" inputmode="tel"` | 电话键盘；允许分隔符。 |
| OTP/验证码 | `inputmode="numeric" autocomplete="one-time-code"` | iOS/Android 自动从短信提取。 |
| 姓名 | `autocomplete="name" / given-name / family-name"` | 更友好的自动填充。 |
| 地址 | `street-address / address-line1 / address-line2 / country / postal-code` | 细分字段效果更好。 |
| 新密码 | `type="password" autocomplete="new-password"` | 触发密码生成与保存。 |
| 现有密码 | `type="password" autocomplete="current-password"` | 匹配已有凭据。 |
| 金额/数字 | `type="text" inputmode="decimal"` | 避免 `number` 的本地化与滚轮坑。 |
| 日期 | `type="date"` | 原生日期选择器；自定义组件也需支持键入。 |

> `placeholder` 仅作示例，**不得替代 label**；小屏与自动填充会遮盖 placeholder。

---

## 4) 键盘可达与焦点管理

- Tab 顺序与视觉顺序一致；不要用正值 `tabindex` 改顺序。  
- 使用 `:focus-visible` 提供清晰焦点；**不要移除 outline**。  
- Esc 关闭弹层/错误汇总；在弹层中注意“焦点陷阱”与返回关闭前焦点。  
- Radio/Checkbox 组保证语义分组，原生已支持方向键与空格切换。

---

## 5) 自定义控件的最小 ARIA 模式

### 5.1 自定义开关（沿用 checkbox 语义）
```html
<input id="notify" type="checkbox" role="switch" />
<label for="notify">开启通知</label>
```

### 5.2 自定义下拉（优先用原生 `select`；必要时用按钮+列表盒）
```html
<div class="combobox" data-open="false">
  <button id="color-btn" aria-haspopup="listbox" aria-expanded="false"
          aria-labelledby="color-label color-btn">请选择颜色</button>
  <span id="color-label" class="visually-hidden">颜色</span>
  <ul id="color-list" role="listbox" tabindex="-1" hidden>
    <li role="option" aria-selected="false">红</li>
    <li role="option" aria-selected="false">绿</li>
    <li role="option" aria-selected="false">蓝</li>
  </ul>
  <input type="hidden" name="color" />
</div>
```
> 键盘：Alt+↓ 打开；↑/↓ 移动；Enter 选中；Esc 关闭；同步隐藏 `input` 的值。

---

## 6) 错误消息与无障碍播报

- 字段级：错误文本紧挨控件，通过 `aria-describedby` 关联；错误时加 `aria-invalid="true"`。  
- 汇总级：顶部“错误汇总”用 `aria-live="assertive"`；每条错误锚点跳转到字段。  
- 颜色不是唯一信号：文本 + 图标 + 颜色三择二。

---

## 7) 安全与隐私

- 最小化收集敏感数据；在文案中明确用途。  
- 正确使用 `autocomplete` 与密码管家配合，而非一律 `autocomplete="off"`。  
- 前端日志/埋点不要记录原始输入，仅记录是否通过校验与错误类型。  
- **服务端必须二次校验**，前端校验只为体验。

---

## 8) 反模式与重构

| 反模式 | 危害 | 重构 |
|---|---|---|
| 用 `placeholder` 代替 `label` | 无辅助文本、自动填充覆盖 | 增加可见 `label`，`placeholder` 仅放示例 |
| 输入金额用 `number` | 本地化小数点/滚轮误触 | `type="text" inputmode="decimal"` + 自定义格式化 |
| 自定义组件无键盘支持 | 无法操作/读屏缺失 | 补齐 ARIA 与键盘事件，或改回原生 |
| 仅用颜色提示错误 | 色弱不可用 | 文本 + 图标 + 颜色 |
| 移除 `outline` | 键盘用户迷失 | 用 `:focus-visible` 自定义但保留对比度 |

---

## 9) 提交前检查清单

- [ ] 所有控件有可见 `label` 并与控件通过 `for/id` 绑定。  
- [ ] 必填项带 `required`；错误时设置 `aria-invalid` 与文本提示。  
- [ ] 顶部错误汇总可聚焦，条目可跳转到字段。  
- [ ] 软键盘/自动填充正常（`type`/`inputmode`/`autocomplete` 已设置）。  
- [ ] Tab 顺序正确；焦点样式清晰；支持键盘操作。  
- [ ] 服务端重复校验；不记录敏感原文。

---

## 10) 可复制的“登录表单最小版”

```html
<form action="/login" method="post" novalidate>
  <div class="field">
    <label for="login-email">邮箱 *</label>
    <input id="login-email" name="email" type="email" required
           autocomplete="email" inputmode="email"
           aria-describedby="login-email-err" />
    <span id="login-email-err" class="error" aria-live="polite"></span>
  </div>

  <div class="field">
    <label for="login-pwd">密码 *</label>
    <input id="login-pwd" name="password" type="password" required
           autocomplete="current-password"
           aria-describedby="login-pwd-err" />
    <span id="login-pwd-err" class="error" aria-live="polite"></span>
  </div>

  <div class="field">
    <input id="remember" name="remember" type="checkbox" />
    <label for="remember">记住我</label>
  </div>

  <button type="submit">登录</button>
</form>
```

---

## 11) 样式与工具类（拷走即用）

```css
/* 焦点可见 */
:focus-visible { outline:3px solid #2563eb; outline-offset:2px; }

/* 错误态边框 */
input[aria-invalid="true"], select[aria-invalid="true"], textarea[aria-invalid="true"]{
  border-color:#b91c1c;
  box-shadow:0 0 0 2px rgba(185,28,28,.15);
}

/* 仅读屏可见 */
.visually-hidden{
  position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;
  overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0;
}
```

---

## 12) 练习

1. 把你项目中的一个复杂表单改造成：字段级错误 + 顶部错误汇总 + `aria-live` 播报。  
2. 针对移动端用户，完善 `inputmode/ autocomplete` 并录屏对比输入效率。  
3. 将一个自定义下拉替换为原生 `select`，或补齐“按钮+列表盒”键盘与 ARIA 支持。
