# 32.1 IM / èŠå¤©å®¤ï¼ˆä» 0 åˆ°å¯ä¸Šçº¿ï¼‰ğŸ’¬âš™ï¸

> çœŸÂ·å·¥ç¨‹è½åœ°æ•™ç¨‹ï¼šä»åè®®è®¾è®¡ã€æ•°æ®æ¨¡å‹ã€æ¶ˆæ¯æŠ•é€’ã€ç¦»çº¿/é‡è¿ã€åŠ å¯†ä¸é£æ§ï¼Œåˆ°ç›‘æ§è¿ç»´ä¸æˆæœ¬ä¼˜åŒ–ã€‚ç›®æ ‡ä¸æ˜¯â€œèƒ½è·‘ä¸€ä¸‹â€ï¼Œè€Œæ˜¯**å¯ç°åº¦ã€å¯å›æ»šã€å¯è§‚æµ‹ã€å¯æ‰©å±•**çš„å·¥ä¸šåŒ– IMã€‚ğŸ§ª

---

## 0ï¼‰äº§å“ä¸ SLOï¼ˆå…ˆç«‹ä¸‹å†›ä»¤çŠ¶ï¼‰

- **æ¶ˆæ¯æŠ•é€’ï¼ˆå•æˆ¿é—´ï¼‰P50 â‰¤ 150msï¼ŒP99 â‰¤ 800ms**ï¼ˆåŒåŒºåŸŸï¼‰ã€‚
- **å¯é æ€§**ï¼šæœåŠ¡å¯ç”¨æ€§ â‰¥ 99.95%ï¼›å•æ¡æ¶ˆæ¯**è‡³å°‘ä¸€æ¬¡æŠ•é€’**ï¼Œå®¢æˆ·ç«¯é€šè¿‡å¹‚ç­‰é”®å®ç°â€œ**çœ‹èµ·æ¥ä¸€æ¬¡**â€ã€‚
- **ä¸€è‡´æ€§**ï¼š**ä¼šè¯å†…å¼ºé¡ºåº**ï¼ˆper-conversation monotonicï¼‰ï¼›è·¨ä¼šè¯æ— å…¨å±€é¡ºåºæ‰¿è¯ºã€‚
- **å®¹é‡**ï¼šå•æˆ¿é—´ 1k å¹¶å‘åœ¨çº¿ã€ç¾¤å†å² â‰¥ 10^7 æ¡ã€‚
- **å®‰å…¨**ï¼šä¼ è¾“å…¨é“¾è·¯ TLSï¼›å¯é€‰ E2EEï¼›è¿è§„å†…å®¹å¯è¿½æº¯ï¼ˆåˆè§„ç•™å­˜ï¼‰ã€‚

---

## 1ï¼‰ç³»ç»Ÿæ€»å›¾ï¼ˆèƒ½è·‘ã€èƒ½é•¿ï¼‰

```
Client(Web/APP)
   â”‚ WebSocket/SSE (Auth=JWT)
â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Realtime Gatewayâ”‚â”€â”€â”€â–º Presence Service (Redis)
â””â”€â”€â–²â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚     â”‚fanout
   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â–º Notification Fanout (APNs/FCM)
   â”‚
   â–¼
Chat Service (Write path: validate â†’ seq â†’ store) 
   â”‚  â””â”€â–º Outbox
   â”‚
   â”œâ”€â–º Event Bus (Kafka/NATS) â”€â”€â–º
   â”‚        â”œâ”€ Indexer(Search/OpenSearch)
   â”‚        â”œâ”€ Analytics/Stream ETL
   â”‚        â””â”€ Webhook/Integration
   â”‚
   â”œâ”€â–º Storage (Postgres/Timescale)  â”€ History API
   â””â”€â–º Object Storage(S3/CDN/Image/AV pipeline)
```

- **Gateway**ï¼šWS ç»ˆç«¯ â†’ æˆ¿é—´è·¯ç”±ã€é€Ÿç‡é™åˆ¶ã€å¿ƒè·³ã€æ–­çº¿ç»­ä¼ ç‚¹ä½ã€‚
- **Chat Service**ï¼šä¼šè¯æƒé™ã€**é¡ºåºå·**åˆ†é…ã€è½åº“ã€**Outbox** å¯é æŠ•é€’ã€‚
- **Presence**ï¼šåœ¨çº¿çŠ¶æ€/æ‰“å­—ä¸­/æœ€åæ´»è·ƒï¼Œèµ° Redisï¼ˆTTLï¼‰ã€‚
- **Push**ï¼šç¦»çº¿è®¾å¤‡ â†’ APNs/FCMï¼›é™éŸ³/æŠ˜å ç­–ç•¥ã€‚
- **æœç´¢/åˆ†æ**ï¼šä» EventBus å¼‚æ­¥æ¶ˆè´¹ï¼Œä¸é˜»å¡å†™è·¯å¾„ã€‚
- **åª’ä½“**ï¼šé¢„ç­¾åç›´ä¼  + å¼‚æ­¥è½¬ç /ç¼©ç•¥å›¾ï¼›ï¼ˆå¯é€‰ï¼‰ç«¯ä¾§åŠ å¯†ã€‚

---

## 2ï¼‰æ¶ˆæ¯åè®®ï¼ˆEnvelope + å¹‚ç­‰ï¼‰

### 2.1 WebSocket åŸºæœ¬å¸§ï¼ˆJSON or MsgPackï¼‰

```ts
// client â†’ server
type C2S =
  | { t: 'auth', jwt: string }
  | { t: 'join', cid: string, since?: number }                // cid=conversation id, since=ä¸Šæ¬¡å·²æ”¶åºå·
  | { t: 'send', cid: string, mid: string, clientId: string, at: number, kind: 'text'|'image'|'sys', body: any }
  | { t: 'ack', cid: string, pos: number }                    // å·²æ¥æ”¶è‡³åºå· pos
  | { t: 'read', cid: string, pos: number }                   // å·²è¯»æ¸¸æ ‡
  | { t: 'typing', cid: string, on: boolean };

// server â†’ client
type S2C =
  | { t: 'ready', userId: string, serverTs: number }
  | { t: 'joined', cid: string, head: number }                // å½“å‰ä¼šè¯å¤´åºå·ï¼ˆæœ€åä¸€æ¡ï¼‰
  | { t: 'message', cid: string, seq: number, mid: string, from: string, at: number, kind: string, body: any }
  | { t: 'ack', cid: string, pos: number }                    // æœåŠ¡ç«¯ç¡®è®¤æ”¶åˆ°å¹¶å…¥åº“
  | { t: 'read', cid: string, pos: number, from: string }
  | { t: 'typing', cid: string, from: string, on: boolean }
  | { t: 'error', code: string, msg: string };
```

- `mid`ï¼šå®¢æˆ·ç«¯ç”Ÿæˆï¼ˆ**ULID/Snowflake**ï¼‰ï¼Œç”¨äºå¹‚ç­‰ä¸å»é‡ã€‚
- `seq`ï¼š**æœåŠ¡ç«¯åˆ†é…çš„ä¼šè¯å†…å•è°ƒé€’å¢åºå·**ï¼ˆå¼ºé¡ºåºä¿éšœï¼‰ã€‚
- `ack.pos`ï¼šæŒ‰ä¼šè¯æ±‡æŠ¥â€œå·²æ”¶è‡³Xâ€ï¼Œä¾¿äº**æ–­çº¿è¡¥å‘**ä¸**æœªè¯»æ•°**è®¡ç®—ã€‚

> **ä¸åšå…¨å±€åºå·**ï¼Œåªåš**æ¯ä¼šè¯åºå·**ï¼Œç®€åŒ–é«˜å¯ç”¨ã€‚

---

## 3ï¼‰å­˜å‚¨æ¨¡å‹ï¼ˆSQL å‹å¥½ & å¯æ‹†åˆ†ï¼‰

### 3.1 è¡¨æ¦‚å¿µï¼ˆPostgres/Prismaï¼‰

```prisma
model Conversation {
  id           String   @id @db.Uuid
  kind         String   // 'dm'|'group'|'channel'...
  createdAt    DateTime @default(now())
  lastSeq      BigInt   @default(0)        // ä¼šè¯å†…åºå·å¤´
  participants Participant[]
  messages     Message[]
}

model Participant {
  conversationId String
  userId         String
  role           String   // 'owner'|'member'|'admin'
  lastReadSeq    BigInt   @default(0)
  joinedAt       DateTime @default(now())
  @@id([conversationId, userId])
}

model Message {
  conversationId String
  seq            BigInt    // ä¸»é”®åŒ…å« seq å®ç°ä¼šè¯å†…å¼ºé¡ºåº
  mid            String    // å®¢æˆ·ç«¯å¹‚ç­‰ id (ULID)
  senderId       String
  kind           String    // 'text'|'image'|'file'|'sys'...
  body           Json      // å†…å®¹ï¼ˆE2EE: å­˜å¯†æ–‡+å…ƒæ•°æ®ï¼‰
  at             DateTime  @default(now())
  edited         Boolean   @default(false)
  deleted        Boolean   @default(false)
  @@id([conversationId, seq])
  @@unique([conversationId, mid])         // å¹‚ç­‰
  @@index([conversationId, at])
}
```

- **å†™è·¯å¾„**ï¼š`SELECT lastSeq FOR UPDATE` â†’ `seq = lastSeq+1` â†’ `INSERT` â†’ `UPDATE lastSeq`ï¼ˆæˆ–ä½¿ç”¨ `GENERATED BY SEQUENCE` per-cidï¼‰ã€‚
- **Outbox**ï¼ˆè¡¨æˆ– logï¼‰ï¼šå†™æ¶ˆæ¯åŒäº‹åŠ¡æ’å…¥ outboxï¼Œåå°å¯é æŠ•é€’åˆ° Kafka/NATSã€‚

### 3.2 é™„åŠ è¡¨

- `Receipt(message_id, user_id, state)`ï¼šé€è¾¾/å·²è¯»æ˜ç»†ï¼ˆå¯æŒ‰ä¼šè¯èšåˆï¼‰ã€‚
- `Reaction(conversation_id, seq, emoji, user_id)`ï¼šæ¶ˆæ¯è¡¨æƒ…ã€‚
- `Attachment(id, uri, mime, size, width, height, enc?)`ï¼šåª’ä½“å…ƒæ•°æ®ã€‚
- `Blocklist(owner, blocked)`ï¼šæ‹‰é»‘å…³ç³»ã€‚
- `Device(user_id, device_id, push_token, platform)`ï¼šæ¨é€è·¯ç”±ã€‚

---

## 4ï¼‰å‘é€ & æŠ•é€’ç®—æ³•ï¼ˆå¼ºé¡ºåº + è‡³å°‘ä¸€æ¬¡ï¼‰

```ts
// ä¼ªä»£ç ï¼šsend(message)
1. æ ¡éªŒ membership / æƒé™ / é€Ÿç‡
2. å¹‚ç­‰æ£€æŸ¥ï¼šè‹¥ (cid, mid) å·²å­˜åœ¨ â†’ ç›´æ¥è¿”å›å­˜é‡è®°å½•ï¼ˆseqï¼‰
3. äº‹åŠ¡å†…ï¼š
   3.1 è·å–ä¼šè¯åºåˆ—å·ï¼ˆfor updateï¼‰â†’ nextSeq
   3.2 æ’å…¥ Message(cid, seq=nextSeq, mid, ...)
   3.3 æ›´æ–° Conversation.lastSeq=nextSeq
   3.4 æ’å…¥ Outbox(topic='delivered', key=cid, payload={seq,...})
4. Fanoutï¼š
   - åœ¨çº¿æˆå‘˜ï¼šGateway æˆ¿é—´å¹¿æ’­ `S2C.message`
   - ç¦»çº¿æˆå‘˜ï¼šè®°å½•æœªè¯»ï¼Œå¼‚æ­¥æ¨ APNs/FCMï¼ˆæŠ˜å  by cidï¼‰
5. è¿”å› `S2C.ack { pos: seq }` ç»™å‘é€è€…
```

- **é‡å¤å‘é€**ï¼šå®¢æˆ·ç«¯æ‰çº¿åé‡å‘åŒ `mid`ï¼Œä¼šå‘½ä¸­ `@@unique` å¹‚ç­‰ã€‚
- **æ–­çº¿è¡¥å‘**ï¼šé‡è¿æ—¶ `join(cid, since=last_pos_from_client)` â†’ æœåŠ¡å™¨**ä» since+1 replay**ã€‚
- **æœªè¯»æ•°**ï¼š`max(0, lastSeq - participant.lastReadSeq)`ï¼›å·²è¯»ä¸ŠæŠ¥æ›´æ–° `lastReadSeq` å¹¶å¹¿æ’­ã€‚

---

## 5ï¼‰è¿æ¥ç®¡ç†ï¼ˆé‡è¿ã€èƒŒå‹ã€é™çº§ï¼‰

- **å¿ƒè·³**ï¼š`ping/pong` 15sï¼›è‹¥ `bufferedAmount` è¶…é˜ˆå€¼ï¼ˆå¦‚ 1MBï¼‰ï¼Œé™é€Ÿ/ä¸¢æ—§ï¼ˆä»…æ‰“å­—/æ­£åœ¨è¾“å…¥è¿™ç±»éå…³é”®äº‹ä»¶ï¼‰ã€‚
- **é‡è¿**ï¼šæŒ‡æ•°é€€é¿ + æŠ–åŠ¨ï¼ˆ500ms â†’ 1s â†’ 2s â†’ â€¦ â‰¤ 8sï¼‰ï¼Œå¸¦ä¸Š**å„ä¼šè¯ since** æ‰¹é‡è¡¥å‘ã€‚
- **é™çº§**ï¼šWS ä¸å¯ç”¨ â†’ **SSE ä¸‹è¡Œ** + **HTTP ä¸Šè¡Œ**ï¼ˆ/sendï¼‰ï¼›ä½“éªŒä¿åº•ã€‚
- **å¤šè®¾å¤‡**ï¼šæ¯è®¾å¤‡ç»´æŠ¤å„è‡ª `lastAckPos`ï¼›**å·²è¯»èšåˆ**å–æœ€å¤§å€¼å¹¿æ’­ã€‚

å®¢æˆ·ç«¯æœ€å°å®ç°ï¼ˆTSï¼‰

```ts
class ChatWS {
  url: string; ws?: WebSocket; since = new Map<string, number>(); retry = 500;
  constructor(url: string) { this.url = url; }
  connect() {
    this.ws = new WebSocket(this.url);
    this.ws.onopen = () => { this.retry = 500; /* auth... join with since */ };
    this.ws.onmessage = (e) => this.onMsg(JSON.parse(e.data));
    this.ws.onclose = () => setTimeout(()=>this.connect(), Math.min(8000, this.retry*=2));
  }
  onMsg(m:any) {
    if (m.t==='message') {
      this.handleMessage(m);                 // render+store
      this.since.set(m.cid, m.seq);
    }
  }
  send(m:any) {
    if (!this.ws || this.ws.readyState!==1 || this.ws.bufferedAmount>1e6) return false;
    this.ws.send(JSON.stringify(m)); return true;
  }
}
```

---

## 6ï¼‰åª’ä½“ä¸å¤§å¯¹è±¡ï¼ˆçœé’±åˆç¨³ï¼‰

- **ç›´ä¼ **ï¼šå®¢æˆ·ç«¯å‘åç«¯ç”³è¯· **é¢„ç­¾å URL**ï¼Œç›´ä¼  S3/å¯¹è±¡å­˜å‚¨ï¼ŒæˆåŠŸåå†å‘æ¶ˆæ¯å¼•ç”¨ã€‚
- **è½¬ç **ï¼šå¼‚æ­¥ç”Ÿæˆç¼©ç•¥å›¾/å¤šç ç‡ï¼›éŸ³è§†é¢‘å¯ä¸Šé˜Ÿåˆ—ä¸æ— å¤´ FFmpeg é›†ç¾¤ã€‚
- **CDN**ï¼šå¸¦é‰´æƒï¼ˆtoken/ç­¾å URLï¼‰ï¼›**ç§æœ‰ç©ºé—´**é…åˆä¸´æ—¶ç­¾åã€‚
- **E2EE åª’ä½“**ï¼šç«¯ä¾§ç”Ÿæˆéšæœº `fileKey`ï¼ˆAES-GCM 256ï¼‰ï¼Œå¯¹æ–‡ä»¶ä½“åŠ å¯†å†ä¸Šä¼ ï¼›æ¶ˆæ¯é‡Œåªå­˜ `uri + iv + keyId`ï¼Œ**ä¸å­˜æ˜æ–‡ key**ï¼ˆä»ä¼šè¯å¯†é’¥æ´¾ç”Ÿæˆ–åŒ…è£…åå¦é€šé“å‘ï¼‰ã€‚

---

## 7ï¼‰å®‰å…¨ï¼šä¼ è¾“ã€å­˜å‚¨ä¸ï¼ˆå¯é€‰ï¼‰ç«¯åˆ°ç«¯åŠ å¯†

- **ä¼ è¾“å±‚**ï¼šå…¨ç«™ TLSï¼›WebSocket WSSï¼›JWT çŸ­æœŸï¼ˆ15â€“60minï¼‰+ åˆ·æ–°ã€‚
- **æƒé™**ï¼šä¼šè¯ ACLï¼ˆç®¡ç†å‘˜ã€æˆå‘˜ã€ç¦è¨€ã€æ‹‰é»‘ï¼‰ï¼›æœåŠ¡ç«¯æ¯æ¡æ¶ˆæ¯æ£€æŸ¥ã€‚
- **é£æ§**ï¼šé€Ÿç‡é™åˆ¶ï¼ˆIP/User/Roomï¼‰ï¼Œé»‘è¯/è¾±éª‚æ£€æµ‹ï¼ˆå¯å¼‚æ­¥æ ‡è®°ä¸å›æ”¶ï¼‰ã€‚
- **E2EE é€‰å‹**ï¼š
  - **2 äººç§èŠ**ï¼šSignal Double Ratchetï¼ˆlibs: libsignalï¼‰ã€‚
  - **ç¾¤èŠ**ï¼šåŸºäºç¾¤å¯†é’¥ï¼ˆMegolm alikeï¼‰æˆ– MLSï¼ˆMessage Layer Securityï¼Œå‰æ²¿æ ‡å‡†ï¼‰ã€‚æœåŠ¡ç«¯åªè§å¯†æ–‡ä¸å…ƒæ•°æ®ã€‚
  - **å¯†é’¥è½®è½¬**ï¼šæˆå‘˜å˜æ›´â†’æ¢ç¾¤å¯†é’¥ï¼›å†å²è®¿é—®æŒ‰ç­–ç•¥ä¿ç•™/å¤±æ•ˆã€‚
  - **åˆè§„**ï¼šè‹¥éœ€å®¡è®¡ç•™å­˜ï¼Œå¯ä»…å¯¹**éƒ¨åˆ†ä¼šè¯**å¼€å¯ E2EEï¼›æˆ–åœ¨ä¼ä¸šåœºæ™¯ç”± KMS æ‰˜ç®¡å¯†é’¥å¹¶å¼ºåˆ¶å®¡è®¡ï¼ˆé€æ˜åº¦è¦å†™è¿›éšç§ç­–ç•¥ï¼‰ã€‚

---

## 8ï¼‰æœç´¢ä¸å½’æ¡£

- **å†™æ—¶å¼‚æ­¥ç´¢å¼•**ï¼šæ¶ˆæ¯è½åº“â†’Outboxâ†’æ¶ˆè´¹è€…å†™å…¥ OpenSearch/Meilisearchï¼ˆå€’æ’ + é«˜äº®ï¼‰ã€‚
- **æŒ‰ä¼šè¯åˆ†ç‰‡**ï¼š`index = chat-YYYYMM` æˆ– hash(cid)%Nï¼›å†·çƒ­åˆ†å±‚ã€‚
- **å½’æ¡£ä¸ TTL**ï¼šç¾¤å†å² > N å¹´è‡ªåŠ¨å†·å†»åˆ°ä¾¿å®œå­˜å‚¨ï¼›æ³•å¾‹åˆè§„ä¿ç•™æœŸå¯é…ç½®ã€‚

---

## 9ï¼‰åœ¨çº¿çŠ¶æ€ & æ­£åœ¨è¾“å…¥ï¼ˆPresenceï¼‰

- Redis `SETEX user:{id} online 1 TTL=30s`ï¼Œå¿ƒè·³åˆ·æ–°ï¼›è®¢é˜… `PUB/SUB` å¹¿æ’­å˜åŒ–ã€‚
- Typingï¼šWS å¹¿æ’­ `typing(on/off)`ï¼Œ**ä¸æŒä¹…åŒ–**ï¼Œè¶…æ—¶è‡ªåŠ¨ç†„ç­ï¼ˆ3â€“5sï¼‰ã€‚

---

## 10ï¼‰æ¨é€ï¼ˆAPNs/FCMï¼‰

- åˆå¹¶ç­–ç•¥ï¼šåŒ cid æœªè¯»æŠ˜å ä¸ºä¸€æ¡ï¼ˆbadge + æ–‡æ¡ˆâ€œX æ¡æ–°æ¶ˆæ¯â€ï¼‰ã€‚
- ç‚¹å‡»æ·±é“¾ï¼šç›´è¾¾ä¼šè¯å¹¶æºå¸¦ since å‚æ•°æ‹‰å–ç¼ºå£ã€‚
- å…æ‰“æ‰°ï¼šå¤œé—´é™éŸ³ã€å·¥ä½œæ—¶æ®µç­–ç•¥ã€@æˆ‘/ç³»ç»Ÿä¾‹å¤–ã€‚

---

## 11ï¼‰è·¨æˆ¿é—´é€šä¿¡ä¸ç¾¤ç®¡ç†

- **å…¥ç¾¤é‚€è¯·/å®¡æ‰¹**ï¼šç³»ç»Ÿæ¶ˆæ¯ + è§’è‰²å‡çº§ï¼›æœåŠ¡ç«¯å¼ºæ ¡éªŒã€‚
- **@æåŠ**ï¼šæå– mention â†’ å•ç‹¬è¡¨ï¼Œæ¨é€å¯ç²¾å‡†åˆ°äººã€‚
- **å­çº¿ç¨‹/å›å¤**ï¼š`threadRootSeq` å­—æ®µå…³è”ï¼›å‰ç«¯ UI æŠ½å±‰å¼å±•ç¤ºã€‚
- **æ¶ˆæ¯ç¼–è¾‘/æ’¤å›**ï¼šä¿ç•™å®¡è®¡çº¿ï¼ˆedited/deleted+whoï¼‰ï¼›æ’¤å›åå¹¿æ’­å ä½å†…å®¹â€œå·²æ’¤å›â€ã€‚

---

## 12ï¼‰è§‚æµ‹ã€è°ƒå‚ä¸æˆæœ¬

- **æŒ‡æ ‡**ï¼š`ws_conn_activeã€msg_write_qpsã€msg_fanout_qpsã€p95_delivery_msã€reconnect_rateã€redis_cmd_qpsã€kafka_lagã€push_success_rate`ã€‚
- **æ—¥å¿—é‡‡æ ·**ï¼šé”™è¯¯ 100%ï¼ŒæˆåŠŸ â‰¤ 1%ï¼›å¼€å¯**æŒ‰ä¼šè¯é‡‡æ ·**ä»¥ä¾¿è¿½æŸ¥ã€‚
- **å®¹é‡è§„åˆ’**ï¼šGateway èŠ‚ç‚¹â‰ˆåœ¨çº¿è¿æ¥æ•°/ï¼ˆ2~5ä¸‡ï¼‰ï¼›Redis å“¨å…µæˆ–é›†ç¾¤ï¼›PG åˆ†ç‰‡æŒ‰ cid Hashï¼›å¯¹è±¡å­˜å‚¨è´¹ç”¨ä¸»å› æ˜¯æµé‡ï¼ˆCDN ç¼“å­˜ç‡>90%ä¸ºå®œï¼‰ã€‚

---

## 13ï¼‰é£æ§ä¸åˆè§„ï¼ˆåˆ«ç­‰ä¸Šçƒ­æœæ‰æƒ³èµ·ï¼‰

- **é€Ÿç‡é™åˆ¶**ï¼štoken bucketï¼šæ¯ç”¨æˆ·/æ¯æˆ¿é—´/æ¯IP ä¸‰æ¡£ã€‚
- **åƒåœ¾æ¶ˆæ¯**ï¼šå†…å®¹æŒ‡çº¹ + ç›¸ä¼¼åº¦ï¼›é¢‘ç¹å¤–é“¾/å¯ç–‘åŸŸåæ‹¦æˆªã€‚
- **ä¸¾æŠ¥/å°ç¦**ï¼šå­˜è¯ï¼ˆæ¶ˆæ¯å¿«ç…§/ä¸Šä¸‹æ–‡ï¼‰ï¼Œæ”¯æŒä¸´æ—¶ç¦è¨€/æ°¸ä¹…å°å·ã€‚
- **åˆè§„**ï¼šGDPR/CCPA æ•°æ®å¯¼å‡ºä¸åˆ é™¤ï¼›**å¹´é¾„é—¨æ§›**ï¼›ä¼ä¸šå®¢æˆ·éœ€è¦**å®¡è®¡å¯¼å‡º**ã€‚

---

## 14ï¼‰ç«¯åˆ°ç«¯ä»£ç éª¨æ¶ï¼ˆå¯ç›´æ¥æŠ„ï¼‰

### 14.1 ç½‘å…³ï¼ˆNode + wsï¼‰

```ts
// gateway.ts
import { WebSocketServer, WebSocket } from 'ws';
import jwt from 'jsonwebtoken';
import Redis from 'ioredis';

type Client = WebSocket & { uid?: string, rooms: Set<string> };
const pub = new Redis(process.env.REDIS_URL!);
const sub = new Redis(process.env.REDIS_URL!);

const wss = new WebSocketServer({ port: 9001 });
const roomMembers = new Map<string, Set<Client>>();

wss.on('connection', (ws: Client, req) => {
  ws.rooms = new Set();
  // auth
  try {
    const token = new URL(req.url!, 'http://x').searchParams.get('token')!;
    const { uid } = jwt.verify(token, process.env.JWT_SECRET!) as any;
    ws.uid = String(uid);
  } catch { return ws.close(4401, 'unauthorized'); }

  ws.on('message', (raw) => handle(ws, raw.toString()));
  ws.on('close', () => leaveAll(ws));
});

async function handle(ws: Client, raw: string) {
  let m: any; try { m = JSON.parse(raw) } catch { return; }
  if (m.t==='join') {
    join(ws, m.cid);
    // è¡¥å‘ï¼šè½¬ç»™ Chat Service çš„ /sync æ¥å£æˆ– Redis Streamï¼ˆç•¥ï¼‰
  } else if (m.t==='send') {
    // é€ä¼ åˆ° Chat Serviceï¼ˆHTTP/RPCï¼‰ï¼›è¿™é‡Œä»…æ¼”ç¤ºå‘å¸ƒ
    await pub.publish(`room:${m.cid}`, JSON.stringify({ t: 'send', from: ws.uid, ...m }));
  } else if (m.t==='ack' || m.t==='read' || m.t==='typing') {
    await pub.publish(`room:${m.cid}`, JSON.stringify({ ...m, from: ws.uid }));
  }
}

function join(ws: Client, cid: string) {
  let set = roomMembers.get(cid); if (!set) roomMembers.set(cid, set = new Set());
  set.add(ws); ws.rooms.add(cid);
}
function leaveAll(ws: Client) { for (const cid of ws.rooms) roomMembers.get(cid)?.delete(ws); }

sub.psubscribe('room:*');
sub.on('pmessage', (_, channel, msg) => {
  const cid = channel.split(':')[1];
  const payload = msg;
  for (const c of roomMembers.get(cid) || []) {
    if (c.readyState === WebSocket.OPEN && c.bufferedAmount < 1e6) c.send(payload);
  }
});
```

> ç”Ÿäº§ï¼š**é‰´æƒæ”¾åˆ° Chat Service**ï¼ŒGateway ä»…è·¯ç”±ï¼›å¹¿æ’­ç”¨ Redis Stream/NATSï¼›åŠ **èƒŒå‹ä¸æ–­çº¿æŒ‡æ ‡**ã€‚

### 14.2 å†™è·¯å¾„ï¼ˆNestJS/Express ä¼ªä»£ç ï¼‰

```ts
// POST /chat/send
// body: { cid, mid, kind, body }
async function send(req, res) {
  const uid = req.ctx.user.id;
  await db.tx(async (tx) => {
    await assertMember(tx, req.body.cid, uid);
    const seq = await nextSeq(tx, req.body.cid);           // SELECT ... FOR UPDATE
    await tx.insert('Message', { conversationId: req.body.cid, seq, mid: req.body.mid, senderId: uid, kind: req.body.kind, body: req.body.body });
    await tx.update('Conversation', { id: req.body.cid }, { lastSeq: seq });
    await tx.insert('Outbox', { topic: 'delivered', key: req.body.cid, payload: { cid:req.body.cid, seq }});
  });
  res.json({ ok: true });
}
```

---

## 15ï¼‰æµ‹è¯•çŸ©é˜µï¼ˆåˆ«è®© bug ä¸Šçº¿æ‰æš´éœ²ï¼‰

- **ä¸€è‡´æ€§**ï¼šä¹±åº/é‡å¤/ä¸¢åŒ…ä¸‹ï¼Œå®¢æˆ·ç«¯è§†å›¾æ˜¯å¦ä¸æœåŠ¡å™¨æœ€ç»ˆä¸€è‡´ã€‚
- **æ–­ç½‘/å¼±ç½‘**ï¼šåˆ‡ 2Gã€ä¸¢åŒ… 10â€“30%ã€å»¶è¿Ÿ 200â€“800msã€‚
- **é«˜å¹¶å‘**ï¼š1k å¹¶å‘å‘é€ï¼ŒP99 æŠ•é€’ä¸ fanout ç›‘æ§ã€‚
- **å®¹ç¾**ï¼šPG ä¸»ä»åˆ‡æ¢ã€Redis åˆ†ç‰‡æŠ–åŠ¨ã€Kafka åå‹ã€‚
- **å›æ”¾**ï¼šå¯¹å•ä¼šè¯ç”Ÿæˆ 10^6 æ¡åˆæˆæ¶ˆæ¯ï¼ŒéªŒè¯ç´¢å¼•ä¸å½’æ¡£æ€§èƒ½ã€‚

---

## 16ï¼‰Checklistï¼ˆè½åœ°ç‰ˆï¼‰âœ…

- [ ] ä¼šè¯å†…å¼ºé¡ºåºï¼ˆseqï¼‰+ å®¢æˆ·ç«¯å¹‚ç­‰ `mid`  
- [ ] Outbox + äº‹ä»¶æ€»çº¿ï¼Œå†™è·¯å¾„ä¸è¢«ä¸‹æ¸¸æ‹–æ…¢  
- [ ] æ–­çº¿ç»­ä¼ ï¼ˆsince/ackï¼‰+ é‡è¿é€€é¿ + èƒŒå‹  
- [ ] ç›´ä¼ åª’ä½“ + é¢„ç­¾å + CDN + ï¼ˆå¯é€‰ï¼‰ç«¯ä¾§åŠ å¯†  
- [ ] å·²è¯»/é€è¾¾ä¸æœªè¯»æ•°ä¸€è‡´æ€§å®šä¹‰æ¸…æ¥š  
- [ ] é€Ÿç‡é™åˆ¶ã€æ‹‰é»‘ã€å†…å®¹é£æ§ã€å®¡è®¡ç•™ç—•  
- [ ] æŒ‡æ ‡/æ—¥å¿—/è¿½è¸ªé½å…¨ï¼Œå¯ç°åº¦ & å¿«é€Ÿå›æ»š  
- [ ] E2EEï¼ˆå¯é€‰ï¼‰ç­–ç•¥ã€å¯†é’¥è½®è½¬ä¸åˆè§„è¯´æ˜  
- [ ] æœç´¢/å½’æ¡£/TTL ä¸æˆæœ¬æ§åˆ¶ç­–ç•¥  

---

### ç»“è¯­

IM çš„éš¾ç‚¹ä¸åœ¨â€œèƒ½ä¸èƒ½æŠŠ A çš„å­—å‘ç»™ Bâ€ï¼Œè€Œåœ¨**é¡ºåºã€å¯é ã€å¯è§‚æµ‹ã€å¯æ¼”åŒ–**ã€‚æŠŠ**åºå·+å¹‚ç­‰**å½“ä¿¡ä»°ï¼ŒæŠŠ**æ–­çº¿è¡¥å‘**å½“æ—¥å¸¸ï¼ŒæŠŠ**é£æ§ä¸éšç§**å½“åº•çº¿ï¼Œä½ çš„èŠå¤©å®¤å°±ä¸æ˜¯â€œç©å…·â€ï¼Œè€Œæ˜¯èƒ½æ‰›äº‹å„¿çš„**åŸºç¡€è®¾æ–½**ã€‚ğŸš€
