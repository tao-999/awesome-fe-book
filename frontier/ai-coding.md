# 28.1 Copilot / Cursor / Codeium 工作流 🧩

> 目标：用**制度化工作流**把 AI 编码从“灵感火花”变成“可控产能”。以下内容聚焦 VS Code/JetBrains 等常见环境，强调**可回放**、**可审查**、**可测**。

---

## 一、共性能力与差异概览

| 维度 | GitHub Copilot | Cursor | Codeium |
|---|---|---|---|
| 形态 | 内联补全 + Chat | **IDE 发行版**（内置 Chat/内联/多文件编辑器） | 扩展（内联 + Chat） |
| 代码库理解 | 依据打开文件/临时索引/上下文 | **项目向量索引**（多文件编辑/批量改动） | 项目索引（向量检索） |
| 多文件改动 | Chat 提示/“应用变更” | **编辑器指令 → 生成 diff → 局部应用** | Chat 指令 → 生成 diff |
| 测试驱动 | Chat 产出测试/修测 | **从失败测试反推修复** | 生成/更新测试 |
| 私密性 | 企业/组织策略可控 | 本地索引 + 云侧推理 | 云侧推理 + 企业方案 |
| 适配 | VS Code/JetBrains/Neovim | VS Code 分支（Cursor App） | VS Code/JetBrains/Neovim |

> 选型心法：**单文件写作与日常补全**倾向 Copilot；**跨文件重构/“编辑器驱动开发”**倾向 Cursor；**成本友好与多编辑器覆盖**考虑 Codeium。实际常见是**混合栈**。

---

## 二、统一工作流（适用于三者）

### 0）准备（一次性）
- **仓库体检**：跑一遍 LSP、lint、type-check、tests，保证基线稳定。
- **上下文裁剪**：把 `node_modules`、打包产物、大二进制加入索引忽略（各插件的 ignore 列表）。
- **密钥隔离**：`.env*` 不进上下文（使用 mock/占位符）。
- **提交规范**：约定 AI 生成提交统一前缀与 Co-authored-by 注记。

### 1）任务分解（Prompt = 协议）
把需求写成**最小 RFC**（≤ 15 行）：
```
# 目标
在 feature X 中新增 A 能力，满足 Y 约束，兼容 Z 平台。

# 输入/边界
- 只改 src/feature-x/*
- 不改 API 的返回值结构
- 保持 100% 现有测试通过

# 检验
- 新增 e2e 用例：
  - 当...应返回...
  - 当...应抛出...
```

### 2）生成（内联/Chat/多文件）
- **小改动**：内联补全（行内/块级），通过片段提示“在此处实现……且 O(n log n) 复杂度”。
- **跨文件**：使用 Chat / 多文件编辑器，给出指令 + 受影响文件列表，要求**输出 diff**。

### 3）审查（Diff-first）
- **仅局部应用**：逐 hunk 检视，拒绝“覆盖式”改动。
- **三件套检查**：lint/type-check/tests。

### 4）回放与记录
- 生成**变更原因**短摘要（50～120 字）。
- 提交信息模板（见下）。

---

## 三、三工具的“最佳使用姿势”

### A. Copilot：日常写作与补全
- **场景**：算法/适配层/接口胶水/样板测试/常见框架写法。
- **做法**：
  - 先写**函数签名 + 完整注释 + 示例调用**，再触发内联补全。
  - 多文件场景转到 **Copilot Chat**：粘贴 RFC + 指定目录，要求输出 **分文件 patch**。
- **提示模板**：
  ```
  请只修改当前文件，完成函数 `formatInvoice`：
  约束：
  - 输入不可变（不可原地修改参数）
  - 必须覆盖含税/未税两种路径
  - 时间复杂度 O(n)
  输出：
  - 仅代码块，不要多余注释
  - 如需新增辅助函数，放在文件底部
  ```

### B. Cursor：多文件编辑与重构
- **场景**：跨模块 API 变化、批量命名重写、按测试失败修复。
- **做法**：
  - 用“**选择 → 指令编辑**”进行局部重写；或 **多文件编辑器**批量改动。
  - 指令中列出**受影响文件**与**禁止触碰文件**；要求生成可审 diff。
- **提示模板**：
  ```
  目标：将分页参数 `page/size` 统一改为 `cursor/limit`。
  范围：src/api/*、src/services/*
  禁止修改：src/pages/*、tests/e2e/*
  要求：
  - 生成带文件路径的 diff
  - 对应类型定义联动更新
  - 更新单测快照
  ```

### C. Codeium：跨编辑器与成本友好
- **场景**：多编辑器团队、轻量试点、跨仓库片段检索补全。
- **做法**：
  - 先触发**代码搜索**找到相似实现，再在 Chat 中“对齐风格/接口”产出实现。
  - 为**测试生成**指定现有断言风格。

---

## 四、测试优先与“失败驱动修复”

### 1）先测后码（TDD 快速通道）
```ts
// user.service.spec.ts
describe('getUserProfile', () => {
  it('sanitizes phone number', async () => {
    const u = await svc.getUserProfile('uid-1');
    expect(u.phone).toMatch(/^\+\d{1,3}-\d{4}-\d{4}$/);
  });
});
```
> Chat 指令：**只修改实现以通过现有测试，不改测试**；输出 diff。

### 2）从失败信息反推
- 将 `jest`/`vitest` 的失败摘要贴给 Chat，附“**只改这些文件**”白名单，要求解释**根因 + 最小修复**。

---

## 五、稳态提示（可直接复用）

**生成器（实现函数）**
```
角色：资深 {框架} 工程师
输入：函数签名 + 示例 + 类型定义
约束：
- 不引入新依赖
- 不改公开接口
- 只修改光标处/所选块
输出：完整实现 + 极端输入处理
```

**重构器（跨文件）**
```
任务：将 {概念A} 重命名为 {概念B} 并保持行为等价
范围：{glob 列表}
禁区：{glob 列表}
产物：统一 diff（unified），分文件说明破坏性变更
```

**测试生成器**
```
给出针对 {模块} 的单元测试：
- 使用 {jest|vitest} 与 {testing-library}
- 覆盖 {成功/异常/边界}
- 固定随机种子
- 无网络 IO（用 mock）
```

---

## 六、上下文喂养策略（减少“答非所问”）

1. **把规则写进文件头**（e.g. `// This module uses dayjs, not moment`）。
2. **提供最小语料**：接口声明、类型、已有示例、错误栈。
3. **限制范围**：文件列表 + 不可修改列表。
4. **要求结构化输出**：`diff` / `patch` / “变更点摘要”。

---

## 七、安全与合规

- **隐私**：不把密钥、客户数据放进对话；使用脱敏样本。
- **索引白名单**：只允许索引 `src/`、`packages/*/src`；排除 `secrets/`。
- **许可证**：对生成代码跑一遍 licenser/依赖审计；对“复制风格”保持审慎。
- **审计**：开启组织/企业版策略（禁用数据回传/保留期/访问控制）。

---

## 八、团队约定与 CI 钩子

- **提交信息模板**
  ```
  feat(user): add masked phone formatter

  Rationale: pass tests in user.service.spec; preserve API stability.
  Co-authored-by: AI Assistant <bot@internal>
  ```
- **CI**：PR 必过 `lint/type/test/size-limit`；AI 生成的 PR 要挂上“需二人审查”标签。
- **回放档案**：保留“提示（精简版）+ 变更摘要”，不保存原始长对话。

---

## 九、常见故障排查

- **跑飞/改太多**：缩小范围 → 仅选中文件 → 重新生成 diff。
- **重复幻觉**：提供“正确的现有实现”示例作为 few-shot。
- **格式失控**：先让工具“生成 patch”，再应用到代码，而不是直接贴文本块。
- **性能退化**：对关键路径要求“时间/空间上限 + 基准用例”，让模型在约束内优化。

---

## 十、示例：从需求到合并（10 分钟脚本）

1. 写 mini-RFC（目标/边界/验收）。  
2. 用 Cursor 多文件指令生成 **diff**。  
3. 仅局部应用 → `lint` → `type-check`。  
4. 让 Copilot 生成/补齐单测；本地跑全量。  
5. Codeium 搜索相似实现，核对风格一致性。  
6. 填写提交信息模板，开 PR（含变更摘要与受影响面）。  

> 记住：AI 负责“生成与重排”，**你**负责“边界与验收”。把约束写清、把范围框死、把测试跑通，就是稳定的日常生产力。

