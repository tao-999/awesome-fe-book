# 33. 工程文化与协作模式 🧭🏗️🤝

> 目标：从“写代码的个人技艺”进化为“可复制、可审计、可持续的**团队操作系统**（Team OS）”。  
> 核心：**清晰的边界**、**轻量的制度**、**高质量的沟通**、**稳定的节律**、**可观测的结果**。

---

## 0）北极星与底层规则（写在最前面）

- **用户价值优先**：任何流程仅为更快、更稳地交付价值服务。  
- **写下来、看得到**：结论不上墙就不算结论，同步口头=异步书面。  
- **小批量、快回路**：小 PR、小发布、小回滚，减少变更风险面。  
- **责权一致**：**DRI（直接责任人）**对结果负责，组织为 DRI 清障。  
- **高心理安全**：犯错=学习机会；**事后无责**的复盘文化。  
- **可观测**：用指标校准认知，用回放复盘改进。

---

## 1）Team OS：节律与工序（能每天照做的那种）

### 1.1 周节律（建议默认）
- **周一·对齐（45min）**：回顾指标、滚动路标、确定本周 DRI/风险。  
- **周中·技术对讲（30min）**：一人一坑，分享一次“把复杂变简单”的实践。  
- **周五·Demo + 复盘（45min）**：演示可运行成果；**KPT**（Keep/Problem/Try）落行动。

### 1.2 日节律（异步优先）
- **Daily（异步 Standup）**：大家在线程里三问：  
  1) 昨天完成 ✅；2) 今天计划 🎯；3) 阻塞求助 🆘（@DRI）。  
- **注意**：开会是**逃避写作**的象征；除非确有需要，不上实时会。

### 1.3 流程骨架（从 Idea 到上线）
```
Idea → RFC → 拆票 → 开发（小 PR）→ 预发 → 灰度 → 上线 → 观测 → 复盘
```
- **DoR（Ready 定义）**：需求可量化、边界清晰、风险已列、验收可复核。  
- **DoD（Done 定义）**：代码过审、测试齐全、监控上线、文档已更、回滚剧本可用。

---

## 2）决策机制：谁拍板、怎么拍、拍完怎么记 📜

- **DRI**：每项工作标注 1 名 DRI（不是管理者，是决策者）。  
- **DACI**：Driver（推进）/Approver（最终批准）/Contributor（贡献）/Informed（知会）。  
- **ADR（架构决策记录）**：每个重要技术决策一页纸即可，存库版本化。

**ADR 模板**
```md
# ADR-007: 在 BFF 采用 tRPC
- Status: Accepted (2025-09-15)
- Context: 后端资源紧、需要端到端类型安全。
- Decision: 选用 tRPC + Zod；对外接口仍保留 REST。
- Consequences: 前端开发提效↑；需维护 API 网关双栈。
- Alternatives: 直接 GraphQL；REST + OpenAPI。
- Owner (DRI): @alice
```

---

## 3）文档即共识：写短、写清、写可执行 ✍️

- **一页纸 PRD**（面向价值与验收）  
- **技术 RFC（≤ 6 页）**：问题—方案—权衡—里程碑—回滚  
- **运行文档**：Runbook、Oncall、故障卡片（SEV）  
- **知识图谱**：ADR/RFC/Runbook 互链；**Docs-as-Code**（同仓、评审、版本）

**一页纸 PRD 模板**
```md
# {功能名} One-Pager
目标/Why：给谁解决什么痛点，有何北极星指标
范围/Out：做什么、不做什么
验收标准：可量化条目（例：转化率+3%，错误率<0.1%）
风险与假设：...
发布计划：灰度人群、回滚条件、观测看板链接
DRI/ Stakeholders：...
```

---

## 4）代码协作：分支、PR、评审、提交信息 🧵

### 4.1 分支策略
- **Trunk-Based**（推荐）：主干受保护；特性分支寿命 ≤ 3 天；**Feature Flag** 控制曝光。  
- **Git hooks**：commitlint（Conventional Commits）、lint-staged、测试门禁。

### 4.2 PR 规则
- **小 PR**：单 PR 改动 **≤ 300 行**；超出请拆。  
- **上下文**：PR 描述中**复用 RFC/任务链接**；附风险与回滚。  
- **SLA**：工作时段 **4 小时内首评**；72 小时无人评审 → 由 DRI 升级。

**PR 模板**
```md
### 目的
- 修复 xxx / 支持 yyy

### 变更点
- 新增：...
- 破坏性：无/有（迁移脚本见 ...）
- 风险与回滚：...

### 验收
- 单测 xx 通过；E2E 场景：...
- 监控：新增指标 xxx，告警门限 yyy
```

### 4.3 评审文化
- **找事实不找人**：指向代码与效能，不评价人格。  
- **二次确认**：破坏性变更至少 2 人批准。  
- **评论风格**：提出问题→给建议→标级别（nit/blocking/suggestion）。

**提交信息规范（Conventional Commits）**
```
feat(auth): support passkeys login
fix(order): correct decimal rounding in tax calc
chore(ci): upgrade actions/setup-node@v4
```

---

## 5）质量门禁与发布策略 🚦

- **Pre-submit**：Type check、Lint、单测、体积/性能阈值、SAST（依赖与代码安全）。  
- **环境**：Dev → Staging（预发）→ Prod；一键回滚脚本。  
- **灰度**：按用户/流量/地理放量；每步有**止损指标**和**自动熔断**。  
- **Feature Flags**：远程开关，支持按租户/用户分群；**过期清理**制度（每周清理会）。

---

## 6）跨团队协作：契约、SLA 与升级通道 🪢

- **API 契约**：OpenAPI/GraphQL SDL/契约测试（Consumer-Driven）。  
- **变更策略**：向后兼容优先；破坏性变更需 **Deprecation Plan**（公告+多版本过渡）。  
- **SLA**：99.9% 可用、P95 延迟、Support 响应时间。  
- **升级路径**：阻塞 > 24h → @Tech Lead；> 72h → @Eng Manager；**公共问题用公共线程**，禁止“私聊拍板”。

---

## 7）会议操作系统：少而精，能不开就不开 🕰️

- **必须具备**：议程、材料（提前 24h）、DRI、预期产物。  
- **时间盒**：30/45/60 分钟；超时进入 **Parking Lot**。  
- **记录**：会后 24h 内产出纪要与行动项，挂到对应 RFC/Issue。  
- **无会日**：每周至少半天 **No Meeting**，保留深度工作时间。

---

## 8）Oncall / 事故响应（SEV）🆘

**分级**
- **SEV-1**：核心功能不可用/大面积故障  
- **SEV-2**：关键路径降级或小范围影响  
- **SEV-3**：非核心功能异常/旁路可用

**流程**
```
告警 → 值班接警（5min）→ 宣布 SEV（建战情群）→ 定责（Incident Commander / Comms / Ops）
→ 缓解（Mitigation）→ 根因分析（RCA）→ 复盘（Blameless Postmortem）
```

**Postmortem 模板**
```md
# Incident PM: {title}
时间线：...
影响范围：用户/收入/时长
根因：技术/流程/人（事实）
修复：立即/中期/长期
教训：哪些信号被忽略？哪些假设错误？
行动项（Owner + 截止日期）：...
```

---

## 9）度量与激励：用指标服务改进，而非管理人 📈

- **DORA**：部署频率、变更前置时间、变更失败率、MTTR。  
- **SPACE**：满意度、绩效、活跃、沟通协作、效率。  
- **反模式**：**行数/PR 数**、报工时长、无意义 KPI；会劫持行为。  
- **可视化**：一个**团队看板**汇总发布频率、失败回滚、事故与解决时长。

---

## 10）人才成长与反馈回路 🌱

- **职级定义（简）**  
  - **L1–L2**：完成定义明确任务，主动求助。  
  - **L3**：独立负责子模块，能拆解任务与写 RFC。  
  - **L4**：跨域协作、技术方案拍板、带 2–3 人小组。  
  - **L5+**：端到端负责关键领域，技术/业务双向影响。  
- **1:1（双周）**：发展为主、状态为辅，**80% 倾听**。  
- **反馈方法（SBI）**：情境（Situation）→ 行为（Behavior）→ 影响（Impact）。  
- **成长计划**：每季 1–2 个**可验证**的成长目标（讲清“如何看见变化”）。

---

## 11）文化反模式 & 解法 🙅‍♂️→✅

| 反模式 | 症状 | 解法 |
|---|---|---|
| 英雄主义 | 关键知识只在某人脑中 | 轮值/交接/文档化；Pair/Mob |
| 会议成瘾 | 无议程、无结论 | 异步优先；会前材料；时间盒 |
| PR 乒乓 | 反复挑小语法 | 先过功能正确性；nit 合并到格式化工具 |
| 口头拍板 | 会后没人记得 | 会内指定 DRI；会后 24h 纪要+ADR |
| 需求飘移 | 总有“顺手再加点” | DoR/DoD 严格；变更走 RFC 微更版 |
| “通知式管理” | 只发指令、不讲为什么 | 背景+目标+约束三件套写清楚 |

---

## 12）落地清单（两周把 Team OS 搭起来）✅

- [ ] 建**团队手册**（Team Handbook）：节律、SLA、决策、Oncall、质量门禁  
- [ ] 启用 **PR 模板 + ADR 模板 + Postmortem 模板**（仓库 `.github/`）  
- [ ] 保护主干：必跑 `lint/test/type`、两人审、自动语义化发布  
- [ ] 每周固定 **Demo + 复盘**；每月一次**技术分享**  
- [ ] 设立 **Feature Flag** 服务与清理日程  
- [ ] 打开 **DORA** 看板与事故看板；设告警阈值与升级路径  
- [ ] 训练 **SBI 反馈**与**KPT 复盘**（十分钟工作坊）

---

## 13）附：可直接拷走的模版合集 📎

**团队工作协议（Working Agreement）**
```md
- 我们默认异步，能写不说；实时会只为分歧/创意/关系维护。
- 提交早于完美：小 PR、快反馈；代码评论只指向事实。
- 每次上线都有回滚剧本；每次事故都有无责复盘。
- 任何决定必须在 24h 内“写下来”，并贴到对应的 RFC/ADR。
- 彼此宽容、对事不对人；意见不同先问“我们要达成什么共同目标？”
```

**灰度/回滚清单**
```md
- Canaries: 5% → 20% → 50% → 100%
- 监控：错误率/延迟/转化/体积/Crash
- 止损：任一指标超过阈值 X 分钟自动回滚
- 回滚指令：`release rollback --to vX.Y.Z`
- 事后：记录原因与下一步修复项（Owner+DDL）
```

**会议议程模板**
```md
时间/地点/主持/记录
目标（可验证的输出是什么）
议程（每项 5/10/15 分钟）
材料链接（RFC/数据）
决定/行动项（DRI + 截止）
```

---

### 结语

工程文化不是墙上的标语，而是**每天都在运行的操作系统**。  
当你的团队能稳定执行“**写下来 → 小批量 → 快回路 → 可观测 → 可回滚**”，  
协作就会从**靠人拉**变成**靠系统跑**。剩下的，就是持续迭代这个系统。🚀🧠

