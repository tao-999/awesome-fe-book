# 14.2 ç¼“å­˜ / åˆ†é¡µ / ä¸€è‡´æ€§ç­–ç•¥ ğŸ§ âš¡

ç›®æ ‡ï¼šæŠŠ **API å±‚çš„â€œé€Ÿåº¦â€å’Œâ€œæ­£ç¡®â€**åŒæ—¶æ‹¿ä¸‹ã€‚ä¸‰ä»¶å¥—ï¼š
- **ç¼“å­˜**ï¼šHTTP / CDN / å®¢æˆ·ç«¯ / æœåŠ¡ç«¯å¤šå±‚ååŒï¼Œå°‘èµ°å¼¯è·¯ã€‚
- **åˆ†é¡µ**ï¼šæ¸¸æ ‡ä¼˜å…ˆï¼Œç¨³å®šæ’åºï¼Œååä¸æ­£ç¡®å…¼é¡¾ã€‚
- **ä¸€è‡´æ€§**ï¼šè¯»å†™é¡ºåºã€å¹¶å‘å†²çªã€é‡è¯•å¹‚ç­‰ï¼Œç³»ç»Ÿè¦â€œè®²é“ç†â€ã€‚

---

## 1) å¤šå±‚ç¼“å­˜çš„è§’è‰²ä¸è¾¹ç•Œ

| å±‚ | å…¸å‹å®ç° | ä¼˜åŠ¿ | æ³¨æ„ç‚¹ |
|---|---|---|---|
| æµè§ˆå™¨æœ¬åœ° | HTTP ç¼“å­˜ã€Service Worker (SW)ã€IndexedDB | 0ms å‘½ä¸­ã€ç¦»çº¿ | `Cache-Control`ã€`Vary`ã€SW ç‰ˆæœ¬ç®¡ç† |
| å…±äº«ç¼“å­˜ | CDNï¼ˆAkamai/Cloudflare/Vercel Edgeï¼‰ã€åå‘ä»£ç†ï¼ˆNGINX/Varnishï¼‰ | å¤§æµé‡å¸è½½ | `s-maxage`ã€`stale-while-revalidate`ã€é‰´æƒ |
| BFF/åº”ç”¨å±‚ | å†…å­˜/LRUã€Redis/KVã€åº”ç”¨çº§ DataLoader | é¿å…çƒ­ç‚¹ç©¿é€ | TTLã€æ ‡ç­¾å¤±æ•ˆã€é›ªå´©ä¸å‡»ç©¿ |
| æ•°æ®æº | DB/æœç´¢å¼•æ“ | å¼ºä¸€è‡´ | æ…¢ã€æ˜‚è´µï¼Œä¸è¦æ¯æ¬¡ç›´æ‰“ |

> **ç­–ç•¥é‡‘å¥**ï¼š**èƒ½è®©å…±äº«ç¼“å­˜æ‰›çš„ï¼Œè®©å…±äº«ç¼“å­˜æ‰›**ï¼›ä¸èƒ½ç¼“å­˜çš„ï¼Œå°½é‡**æ¡ä»¶è¯·æ±‚**ï¼ˆ304ï¼‰ï¼Œæœ€åå†ä¸Šåº”ç”¨çº§ç¼“å­˜ã€‚

---

## 2) HTTP ç¼“å­˜è¯­ä¹‰é€ŸæŸ¥

### 2.1 å¸¸ç”¨å¤´
- `Cache-Control`:  
  - `public, max-age=60, stale-while-revalidate=600`ï¼ˆæµè§ˆå™¨+CDNéƒ½å¯ç¼“å­˜ï¼‰  
  - `private, max-age=0, no-store`ï¼ˆå¼ºåˆ¶ç¦ç”¨ï¼‰  
  - å¯¹ CDN ä½¿ç”¨ `s-maxage=60` è¦†ç›–å…±äº«ç¼“å­˜ TTL
- æ¡ä»¶è¯·æ±‚ï¼š`ETag` + `If-None-Match`ã€`Last-Modified` + `If-Modified-Since`
- å˜ä½“ï¼š`Vary: Accept-Encoding, Origin, Authorization`ï¼ˆè°¨æ…å¢åŠ ï¼Œé¿å…ç¼“å­˜ç¢ç‰‡åŒ–ï¼‰
- æˆæƒå“åº”ï¼šé»˜è®¤**ä¸ç¼“å­˜**ï¼›å¯ç”¨ `Cache-Control: private, max-age=30`ï¼ˆä»…æµè§ˆå™¨ï¼‰

### 2.2 å…¸å‹é…ç½®ï¼ˆè¯¦æƒ…é¡µï¼‰
```
Cache-Control: public, max-age=60, stale-while-revalidate=600
ETag: "p_123@rev_42"
```
å®¢æˆ·ç«¯ä¸‹ä¸€æ¬¡ï¼š
- å¸¦ `If-None-Match: "p_123@rev_42"` â†’ å‘½ä¸­è¿”å› `304 Not Modified`ï¼Œæçœå¸¦å®½ã€‚

### 2.3 åˆ—è¡¨/æœç´¢çš„ç¼“å­˜
- çƒ­é—¨åˆ—è¡¨ï¼šå¯ `public, s-maxage=30` ç»™ CDNï¼Œæµè§ˆå™¨ `max-age=0` ä»¥å…ç”¨æˆ·çœ‹åˆ°è¿‡æ—§åˆ—è¡¨ã€‚
- ä¸ªæ€§åŒ–/ç§æœ‰åˆ—è¡¨ï¼š**åªç”¨æµè§ˆå™¨ç¼“å­˜** æˆ–ç›´æ¥ `no-store`ï¼›æ”¹èµ° **æœ¬åœ° index + å¢é‡åŒæ­¥**ï¼ˆè§ Â§6ï¼‰ã€‚

---

## 3) å¤±æ•ˆä¸å†éªŒè¯ï¼šä»â€œæ¸…ç¼“å­˜æ˜¯ä¸–ç•Œä¸Šæœ€éš¾çš„äº‹â€æ¯•ä¸š

### 3.1 äº‹ä»¶é©±åŠ¨å¤±æ•ˆï¼ˆæ¨èï¼‰
- ä¸ºèµ„æºæ‰“**æ ‡ç­¾**ï¼ˆTagï¼‰ï¼š`product:123`, `category:book`
- å†™å…¥/å˜æ›´åå‘å¸ƒå¤±æ•ˆäº‹ä»¶ â†’ CDN/BFF æ ¹æ® Tag **æ‰¹é‡ purge**  
  ï¼ˆCloudflare Cache-Tagã€Fastly Surrogate-Keyã€Vercel Revalidate Tagï¼‰

### 3.2 åŸºäºç‰ˆæœ¬çš„è¢«åŠ¨å¤±æ•ˆ
- `ETag` ä½¿ç”¨ **ç‰ˆæœ¬å·/å†…å®¹å“ˆå¸Œ**ï¼›æ¯æ¬¡è¯»å–éƒ½æ¡ä»¶è¯·æ±‚ï¼ˆ304ï¼‰ï¼Œâ€œçœ‹ä¼¼æ–°é²œâ€çš„è€å‰¯æœ¬ä¹Ÿèƒ½è¢«æœåŠ¡å™¨æ‹’ç»ã€‚
- é€‚ç”¨ **è¯»å¤šå†™å°‘** åœºæ™¯ï¼Œé¿å…ä¸»åŠ¨æ¸…ç¼“å­˜çš„å¤æ‚æ€§ã€‚

### 3.3 SWR / SIE
- `stale-while-revalidate`ï¼šå…ˆå›è€æ•°æ®ï¼Œåå°å¼‚æ­¥æ‹‰æ–°ï¼ˆ**å¿«ä¸”æœ€ç»ˆä¸€è‡´**ï¼‰ã€‚
- `stale-if-error=600`ï¼šä¸Šæ¸¸æ•…éšœæ—¶å›æ—§å‰¯æœ¬ï¼ŒæŠ—æŠ–åŠ¨ã€‚

---

## 4) åº”ç”¨å±‚ç¼“å­˜ï¼šå‘½ä¸­è¦ç¨³ã€å¤±æ•ˆè¦å‡†

### 4.1 Key è®¾è®¡
- è¯»ï¼š`cacheKey = ${route}?${canonicalQuery}`ï¼ˆæ’åº/é»˜è®¤å€¼æ ‡å‡†åŒ–ï¼‰
- å†™ï¼š**ä¸¤æ®µå¼**  
  1) **å†™æ•°æ®åº“**ï¼ˆæˆåŠŸï¼‰  
  2) **å‘å¸ƒå¤±æ•ˆ**ï¼ˆæŒ‰ Tag æˆ– Key å‰ç¼€ï¼‰  
  â€”â€”å¤±è´¥å¯é‡è¯•ï¼Œä¿è¯**å…ˆå†™åå¤±æ•ˆ**

### 4.2 é˜²å‡»ç©¿/ç©¿é€/é›ªå´©
- **çƒ­ç‚¹é¢„çƒ­**ï¼šéƒ¨ç½²åå…ˆæ‹‰å–çƒ­é—¨ Keyã€‚
- **ç©ºå€¼ç¼“å­˜**ï¼šå¯¹ä¸å­˜åœ¨çš„èµ„æºç¼“å­˜çŸ­ TTL çš„â€œç©ºâ€ï¼ŒæŒ¡ä½æš´åŠ›ç©·ä¸¾ã€‚
- **æŠ–åŠ¨ TTL**ï¼š`baseTTL * (0.9 ~ 1.1)` éšæœºåŒ–ï¼Œé˜²åŒæ—¶è¿‡æœŸé›ªå´©ã€‚
- **å•é£é˜€**ï¼šå¯¹åŒä¸€ Key çš„å¹¶å‘ miss åˆå¹¶ä¸ºä¸€æ¬¡ï¼ˆè¯·æ±‚åˆå¹¶ï¼‰ã€‚

---

## 5) åˆ†é¡µï¼šæ¸¸æ ‡ä¼˜å…ˆï¼Œç¨³å®šæ’åº

### 5.1 ä¸ºä»€ä¹ˆä¸ç”¨ offsetï¼Ÿ
- `offset/limit` åœ¨**é¢‘ç¹æ’å…¥/åˆ é™¤**æ—¶ä¼š**ç¿»é¡µé”™ä½**ï¼Œæ€§èƒ½åœ¨å¤§åç§»é‡ä¸‹ä¹Ÿå·®ã€‚

### 5.2 æ¸¸æ ‡ï¼ˆKeysetï¼‰åˆ†é¡µè§„èŒƒ

**æ’åºé”®ï¼š**ä½¿ç”¨**å•è°ƒ**ä¸”**å¯æ¯”**çš„å­—æ®µï¼Œé€šå¸¸ `createdAt` + `id` ä½œä¸ºå¤åˆé”®ã€‚  
**æ¸¸æ ‡ç»“æ„ï¼š**
```json
{
  "items": [{ "id": "p1" }, { "id": "p2" }],
  "nextCursor": "eyJjcmVhdGVkQXQiOiIyMDI1LTEwLTAxVDA4OjAwOjAwWiIsImlkIjoicDIifQ=="
}
```
- `nextCursor` æ˜¯æ’åºé”®çš„**åºåˆ—åŒ–å¹¶ base64**ï¼›**ä¸è¦**æŠŠä¸šåŠ¡æŸ¥è¯¢ç›´æ¥å¡è¿›æ¸¸æ ‡ã€‚
- åå‘åˆ†é¡µéœ€è¦æä¾› `prevCursor` ä¸ç›¸åæ’åºã€‚

**SQLï¼ˆPostgreSQLï¼‰ç¤ºä¾‹ï¼š**
```sql
-- æ­£åºï¼ˆcreated_at, idï¼‰
SELECT * FROM products
WHERE (created_at, id) > (:created_at, :id)
ORDER BY created_at, id
LIMIT :limit;
```

**ç¨³å®šæ€§è¦ç‚¹ï¼š**
- æ—¶é—´æˆ³å¯èƒ½åŒç§’å¹¶å‘ï¼Œ**å¿…é¡»åŠ  id ä½œä¸ºæ¬¡åº**ã€‚
- ä¸è¦å…è®¸å®¢æˆ·è‡ªç”±æ’åºåè¿˜æƒ³â€œæ¸¸æ ‡ç¨³å®šâ€ï¼Œ**ç¨³å®šæ¸¸æ ‡åªå¯¹å›ºå®šæ’åºæˆç«‹**ã€‚

### 5.3 åˆ†é¡µä¸ç¼“å­˜çš„ç»“åˆ
- åˆ—è¡¨é¡µç¼“å­˜ Keyï¼š`/v1/products?filter=...&sort=...&limit=20&cursor=abc`  
- **å‘½ä¸­ç‡æå‡**ï¼šå¯¹â€œç¬¬ä¸€é¡µâ€ä¸å¸¸è§è¿‡æ»¤æ¡ä»¶å•ç‹¬åŠ  CDN ç¼“å­˜ï¼›åç»­é¡µäº¤ç»™å®¢æˆ·ç«¯æœ¬åœ°ç¼“å­˜ï¼ˆè§ Â§6ï¼‰ã€‚

---

## 6) å®¢æˆ·ç«¯ç¼“å­˜ä¸è„±æœºç­–ç•¥ï¼ˆSWR/React Queryï¼‰

- **æŸ¥è¯¢é”®å³å¥‘çº¦**ï¼š`['products', { filter, sort, cursor }]`
- **èšåˆçª—å£**ï¼šå¯¹åŒé”®åœ¨çŸ­æ—¶é—´å†…çš„é‡å¤è¯·æ±‚åˆå¹¶ï¼ˆ`dedupingInterval`ï¼‰
- **å¤±æ•ˆé©±åŠ¨**ï¼šå†™æˆåŠŸå `invalidateQueries(['products'])` â†’ è§¦å‘é‡æ‹‰  
- **ç¦»çº¿/å¼±ç½‘**ï¼šç”¨ IndexedDB + èƒŒæ™¯åŒæ­¥ï¼ˆSWï¼‰ï¼Œé¡µé¢ç”¨ **SWRï¼ˆå…ˆæ—§åæ–°ï¼‰** ä¸Šå±ã€‚

---

## 7) ä¸€è‡´æ€§ï¼šå†™å…¥é¡ºåºã€è¯»åå¯è§ã€å¹¶å‘å†²çª

### 7.1 ä¸€è‡´æ€§ç­‰çº§ï¼ˆå¯¹è°ƒç”¨è€…è®²æ¸…æ¥šï¼‰
- **å¼ºä¸€è‡´ï¼ˆRead-After-Writeï¼‰**ï¼šåŒç”¨æˆ·å†™åè¯»ç«‹åˆ»å¯è§ã€‚  
  - åšæ³•ï¼š**å†™è·¯å¾„**ç›´è¾¾ä¸»åº“ï¼›**è¯»è·¯å¾„**å¯¹å†™è€…èµ°**åŒå¯ç”¨åŒº/åŒè¿æ¥æ± **æˆ– **stickinessï¼ˆç²˜æ»ä¼šè¯ï¼‰**ã€‚  
- **æœ€ç»ˆä¸€è‡´**ï¼šå¯èƒ½çœ‹åˆ°æ—§æ•°æ®ï¼Œä½†åœ¨ SLA æ—¶é—´å†…æ”¶æ•›ã€‚  
  - åšæ³•ï¼šSWRã€äº‹ä»¶é©±åŠ¨é‡æ‹‰ã€UI æ ‡è®°â€œæ•°æ®å¯èƒ½å»¶è¿Ÿâ€ã€‚

### 7.2 ä¹è§‚å¹¶å‘æ§åˆ¶ï¼ˆOCCï¼‰
- å“åº”æºå¸¦ `version` æˆ– `ETag`ï¼›æ›´æ–°æ—¶å¸¦ `If-Match`ï¼š
```
If-Match: "rev_42"
```
- ç‰ˆæœ¬ä¸åŒ¹é… â†’ `409 CONFLICT`ï¼Œå‰ç«¯**æ‹‰æ–°ç‰ˆæœ¬ + åˆå¹¶/é‡è¯•**ã€‚

### 7.3 å¹‚ç­‰ä¸é‡è¯•
- **å†™æ“ä½œè¦æ±‚ `Idempotency-Key`**ï¼šç”±å®¢æˆ·ç«¯ç”Ÿæˆï¼ˆUUID/ULIDï¼‰ï¼ŒæœåŠ¡ç«¯ä¿å­˜ï¼ˆé”® + æŒ‡çº¹ï¼‰  
  - ç½‘ç»œé‡è¯•/è¶…æ—¶é‡å‘ä¸ä¼šé‡å¤ä¸‹å•/æ‰£è´¹ã€‚  
- PUT æ•´ä½“æ›¿æ¢å¤©ç”Ÿå¹‚ç­‰ï¼›**PATCH å¿…é¡»é…å¹‚ç­‰é”®**ã€‚

### 7.4 äº‹åŠ¡ä¸è·¨è¾¹ç•Œä¸€è‡´æ€§
- **æœ¬åœ°äº‹åŠ¡** + **Outbox**ï¼šå†™åº“ä¸è®°å½•äº‹ä»¶åœ¨åŒäº‹åŠ¡ï¼Œå¼‚æ­¥æŠ•é€’åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…å»**æ¸…ç¼“å­˜/æ›´æ–°æ´¾ç”Ÿè¡¨**ã€‚  
- **ä¸è¦è¿½æ±‚â€œç»å¯¹ä¸€æ¬¡â€**ï¼šé€šè¿‡å¹‚ç­‰æ¶ˆè´¹ä¸å»é‡è¡¨å®ç°**â€œè‡³å°‘ä¸€æ¬¡ + å¹‚ç­‰ = çœ‹èµ·æ¥ä¸€æ¬¡â€**ã€‚

---

## 8) é’ˆå¯¹ä¸åŒæ•°æ®å½¢æ€çš„ç¼“å­˜æ¨¡æ¿

### 8.1 è¯¦æƒ…èµ„æºï¼ˆè¯»å¤šå†™å°‘ï¼‰
- å¤´éƒ¨ï¼š`public, max-age=60, stale-while-revalidate=600` + `ETag`  
- å¤±æ•ˆï¼šæŒ‰ **Tag**ï¼ˆ`product:123`ï¼‰æ¸…é™¤ï¼›æˆ–ç‰ˆæœ¬å·ä¸Šæµ®åˆ° `ETag`

### 8.2 åˆ—è¡¨/Feedï¼ˆå˜åŒ–å¿«ï¼‰
- é¦–å±ï¼šCDN `s-maxage=15`ï¼ˆä»…å…¬å…±åˆ—è¡¨ï¼‰ï¼›æµè§ˆå™¨ `max-age=0`ï¼Œé…åˆ SWR  
- åç»­é¡µï¼šåªåš**å®¢æˆ·ç«¯ç¼“å­˜**ï¼ŒæœåŠ¡ç«¯ä¸å¼ºç¼“å­˜

### 8.3 ä¸ªæ€§åŒ–æ•°æ®ï¼ˆå¸¦æˆæƒï¼‰
- `Cache-Control: private, max-age=0, must-revalidate`  
- æµè§ˆå™¨æ¡ä»¶è¯·æ±‚èŠ‚æµï¼›CDN ä¸ç¼“å­˜ï¼ˆæˆ–ä½¿ç”¨ Keyed-By-User çš„ç½‘å…³å±‚ï¼‰

### 8.4 è®¡ç®—æ˜‚è´µçš„èšåˆ
- åº”ç”¨å±‚ KV/Redisï¼ŒTTL 1~5 åˆ†é’Ÿ + æŠ–åŠ¨ï¼›  
- å¤±æ•ˆäº‹ä»¶è§¦å‘**ç²¾å‡†é‡ç®—**ï¼ˆä¾‹å¦‚æŸä¸ªåº—é“ºé”€é‡å˜åŒ– â†’ åªé‡ç®—è¯¥åº—é“ºæ¦œå•ï¼‰

---

## 9) GraphQL / tRPC åœºæ™¯è¡¥å……

- **GraphQL**ï¼šç”¨ **Persisted Queryï¼ˆAPQï¼‰** æŠŠ Query æ‘˜è¦åŒ– â†’ CDN ä»¥ hash ä¸º Key ç¼“å­˜ï¼›åˆ†å— `@defer/@stream` å‡å°‘é¦–å±ç­‰å¾…ã€‚  
- **tRPC**ï¼šä¾èµ– **React Query/SWR**ï¼›åœ¨ BFF å±‚åŠ  **è·¯ç”±çº§ç¼“å­˜**ï¼ˆè¾“å…¥åºåˆ—åŒ–ä¸º Keyï¼‰ï¼Œè¾“å‡ºæºå¸¦ `ETag` ä»¥ä¾¿æµè§ˆå™¨æ¡ä»¶è¯·æ±‚ã€‚

---

## 10) ç›‘æ§ä¸å‹æµ‹ï¼šéªŒè¯â€œåˆå¿«åˆå¯¹â€

- **å‘½ä¸­ç‡**ï¼šCDN/BFF å‘½ä¸­ç‡ï¼ˆHIT/MISS/EXPIRED/BYPASSï¼‰ï¼›  
- **304 æ¯”ä¾‹**ï¼šæ¡ä»¶è¯·æ±‚æˆåŠŸç‡ï¼ˆè¶Šé«˜è¶Šçœå¸¦å®½ï¼‰ï¼›  
- **çƒ­ç‚¹é”®**ï¼šå‰ 100 Key QPS/å»¶è¿Ÿï¼›  
- **åˆ†é¡µè´¨é‡**ï¼šç¿»é¡µé‡å¤ç‡ã€æ¼è¯»ç‡ï¼ˆåŸºäºæ¸¸æ ‡å›æ”¾æµ‹è¯•ï¼‰ï¼›  
- **ä¸€è‡´æ€§**ï¼šå†™åè¯»å»¶è¿Ÿ P95ï¼›å†²çªç‡ï¼ˆ409ï¼‰ä¸é‡è¯•æˆåŠŸç‡ã€‚  
- **å‹æµ‹**ï¼šæ¨¡æ‹Ÿçªåˆºåœ¨â€œç¼“å­˜æ¸…ç©º + å†·å¯åŠ¨ + çƒ­é—¨åˆ—è¡¨â€ç»„åˆä¸‹çš„è¡Œä¸ºï¼Œæ£€æŸ¥æ˜¯å¦é›ªå´©ã€‚

---

## 11) åæ¨¡å¼ä¸çº å ğŸ§¨

| åæ¨¡å¼ | ç—‡çŠ¶ | çº å |
|---|---|---|
| ä¸€ä¸Šæ¥ `no-store` | å¸¦å®½ä¸æˆæœ¬çˆ†ç‚¸ | ç”¨ `ETag` + æ¡ä»¶è¯·æ±‚ï¼›å¯ç¼“å­˜çš„éƒ½ç¼“å­˜ |
| åªé  `max-age` | æ•°æ®é™ˆæ—§ | å åŠ  `stale-while-revalidate` æˆ–äº‹ä»¶å¤±æ•ˆ |
| CDN + `Set-Cookie` æ··ç”¨ | è¢«åŠ¨ç¦ç”¨ç¼“å­˜ | ç”¨ `Cache-Control: private` æˆ–ç§»é™¤ä¸å¿…è¦ cookie |
| åˆ—è¡¨ offset åˆ†é¡µ | æ¼/é‡ | æ”¹æˆ **æ¸¸æ ‡ + ç¨³å®šæ’åº** |
| æ¸¸æ ‡åŒ…å«ä¸šåŠ¡æŸ¥è¯¢ | å®‰å…¨éšæ‚£ã€è€¦åˆ | åªåŒ…å«**æ’åºæ–­ç‚¹**ï¼ˆæ—¶é—´æˆ³+idï¼‰ |
| å…¨å±€ç¼“å­˜æ¸…ç©º | é›ªå´© | æ ‡ç­¾/å‰ç¼€ç²¾ç¡®æ¸…ã€é€æ­¥å¤±æ•ˆ |
| æ²¡æœ‰å¹‚ç­‰ | é‡å¤æ‰£è´¹/ä¸‹å• | `Idempotency-Key` + æŒ‡çº¹å»é‡ |
| å¤šå‰¯æœ¬è¯»å†™æ··é£ | å†™åä¸å¯è§ | å†™ç›´ä¸»åº“ + è¯»ç²˜æ»/åŒå¯ç”¨åŒº |

---

## 12) æäº¤å‰æ£€æŸ¥æ¸…å• âœ…

- [ ] è¯¦æƒ…æ¥å£è¿”å› `ETag`ï¼Œæ”¯æŒ `If-None-Match`ï¼›å…¬å…±åˆ—è¡¨è®¾ç½® `s-maxage` ä¸ `stale-while-revalidate`ã€‚  
- [ ] åˆ†é¡µé‡‡ç”¨ **æ¸¸æ ‡**ï¼Œæ¸¸æ ‡ä»…åŒ…å«**æ’åºæ–­ç‚¹**ï¼›æä¾› `nextCursor`ï¼ˆå’Œ `prevCursor` å¦‚éœ€ï¼‰ã€‚  
- [ ] å†™æ“ä½œæ”¯æŒ **Idempotency-Key**ï¼›æ›´æ–°ä½¿ç”¨ **If-Match/ç‰ˆæœ¬å·** åšä¹è§‚å¹¶å‘ã€‚  
- [ ] å˜æ›´åæœ‰**äº‹ä»¶é©±åŠ¨å¤±æ•ˆ**ï¼ˆTag/Key å‰ç¼€ï¼‰ï¼Œæˆ–ä½¿ç”¨ç‰ˆæœ¬åŒ– ETag è¢«åŠ¨å¤±æ•ˆã€‚  
- [ ] å®¢æˆ·ç«¯ç”¨ **SWR/React Query**ï¼šæŸ¥è¯¢é”®è§„èŒƒã€å†™åå¤±æ•ˆã€ç¦»çº¿å¯å›æ”¾ã€‚  
- [ ] è§‚æµ‹é¢æ¿åŒ…å«ï¼šCDN å‘½ä¸­ç‡ã€304 æ¯”ä¾‹ã€P95 å»¶è¿Ÿã€409 å†²çªç‡ã€å†™åè¯»å»¶è¿Ÿã€‚  

---

## 13) é™„ï¼šæœ€å°å‚è€ƒå®ç°ç‰‡æ®µ

**Nodeï¼ˆKoaï¼‰ç»™è¯¦æƒ…é¡µåŠ æ¡ä»¶ç¼“å­˜**
```ts
router.get('/v1/products/:id', async (ctx) => {
  const p = await db.products.findById(ctx.params.id);
  if (!p) { ctx.status = 404; return; }

  const etag = `"p_${p.id}@rev_${p.version}"`;
  ctx.set('ETag', etag);
  ctx.set('Cache-Control', 'public, max-age=60, stale-while-revalidate=600');

  if (ctx.get('If-None-Match') === etag) { ctx.status = 304; return; }

  ctx.body = { id: p.id, title: p.title, price: p.price, version: p.version };
});
```

**æ¸¸æ ‡åˆ†é¡µï¼ˆTypeScriptï¼‰**
```ts
type Cursor = { createdAt: string; id: string };
const encode = (c: Cursor) => Buffer.from(JSON.stringify(c)).toString('base64');
const decode = (s?: string | null) =>
  s ? (JSON.parse(Buffer.from(s, 'base64').toString()) as Cursor) : null;

async function listProducts({ cursor, limit = 20 }: { cursor?: string; limit?: number }) {
  const c = decode(cursor) ?? { createdAt: '0001-01-01T00:00:00Z', id: '' };
  const rows = await sql/* sql */`
    SELECT * FROM products
    WHERE (created_at, id) > (${c.createdAt}, ${c.id})
    ORDER BY created_at, id
    LIMIT ${limit}
  `;
  const next = rows.length === limit
    ? encode({ createdAt: rows[rows.length - 1].created_at, id: rows[rows.length - 1].id })
    : null;
  return { items: rows, nextCursor: next };
}
```

---

**å°ç»“**ï¼šç¼“å­˜è®©ç³»ç»Ÿ**å¿«**ï¼Œåˆ†é¡µè®©æ•°æ®**ç¨³**ï¼Œä¸€è‡´æ€§è®©ç”¨æˆ·ä½“éªŒ**å¯ä¿¡**ã€‚åˆç†ç»„åˆ `SWR + æ¸¸æ ‡ + ETag/If-* + äº‹ä»¶å¤±æ•ˆ + å¹‚ç­‰/ä¹è§‚å¹¶å‘`ï¼Œä½ çš„ API å°±èƒ½åœ¨é«˜å¹¶å‘ä¸å˜æ›´é¢‘ç¹çš„ç°å®ä¸–ç•Œé‡Œï¼Œè·‘å¾—å¿«ã€ç«™å¾—ç¨³ã€è¯´å¾—æ¸…ã€‚ğŸš€
