# 18.4 隐私与法规：GDPR / CCPA / PIPL 🕵️‍♀️📜

目标：给大前端同学一份**可落地**的隐私合规作业单，不当“懂王”，但把**该做的机制**一次性铺平：数据最小化、同意与偏好、数据主体请求（DSR）、跨境与第三方、告警与留痕。  
口号：**少收、晚用、好记、可删、可证**。

> 免责声明：本章是工程与产品视角的**实践指南**，并非法律意见。涉及具体业务、地域适用与条款，请与公司法务/隐私官（DPO/负责人）对齐。

---

## 0) TL;DR（速记）🎯
- **先做数据盘点**：知道你到底收什么、为啥收、放哪儿、谁能看、多久删（ROPA）。  
- **默认最小化**：没有必要的字段就别要；能匿名就不去标识。  
- **先拦后放**：非必要 Cookie/SDK **在同意前禁用**；支持 **GPC（Global Privacy Control）**。  
- **权限可控**：一键导出/删除/纠正/撤回/拒绝出售与分享（CCPA），接口打通。  
- **跨境合规**：SCC/标准合同/评估 + 第三方协议（DPA/合同）齐活。  
- **证据留痕**：同意版本、时间、上下文、策略版本全都**可审计**。  
- **72小时**：一旦发生泄露，GDPR 对监管通报**一般不超过 72 小时**，预先排练应急。

---

## 1) 三大法域概要（工程向）🗺️
| 主题 | GDPR（欧盟） | CCPA/CPRA（加州） | PIPL（中国大陆） |
|---|---|---|---|
| 适用对象 | 在欧盟或处理欧盟居民数据 | 在加州/面向加州居民且达阈值企业 | 在中国境内处理或处理境内个人信息 |
| 角色 | 控制者 / 处理者 | 业务（Business）/ 服务提供商 | 个人信息处理者 / 受托处理者 |
| 法律基础 | 同意、合同、法定义务、重大利益、公共利益、**正当利益** | 更偏向“**消费者权利**”与“出售/共享/敏感信息” | 同意、合同履行、人力资源管理、法定职责、突发公共卫生等 |
| 关键权利 | 访问、纠正、删除、限制、反对、可携带 | 知情、访问、删除、纠正、**拒绝出售/共享**、限制敏感信息处理 | 知情、同意、访问、复制、纠正、删除、撤回、解释、拒绝自动化决策 |
| Cookie/追踪 | 需**事前同意**（除必要类） | 可在**之后选择退出**（销售/共享） + “Do Not Sell/Share” | 敏感信息需**单独同意**；显著告知 |
| 跨境 | SCC/CTD/豁免等 | 与服务商合同、禁止向第三方“出售” | 安全评估/认证/**标准合同** + 影响评估 |

> 工程要点：GDPR 更“先许可后追踪”；CCPA 强调“给退出按钮”；PIPL 强调“显著告知 + 单独同意 + 数据本地与跨境流程”。

---

## 2) 合法性基础与数据分类 🧩
### 2.1 合法性基础（选择其一，并写进代码与文档）
- **同意（Consent）**：自愿、明确、可撤回；前端必须能记录**版本与上下文**。  
- **合同（Contract）**：为履行用户与我们之间的合同所必需。  
- **法定义务 / 公共利益 / 重大利益**：较少见，留文档证据。  
- **正当利益（Legitimate Interest，GDPR）**：做过利益衡量（LIA），并提供**反对权**。

### 2.2 数据分类（工程标注）
- **PI（个人信息）**、**SPI/敏感信息**（如精确定位、身份证件、财务、健康、未成年人）。  
- **匿名化** ≠ **去标识化**：匿名化（不可逆）可以视为“脱离个人信息范围”；去标识化仍是个人信息，需保护。

---

## 3) 数据盘点（ROPA）与“最少可行事件” 📒
建立一份“**事件→目的→基础→存储→保留→第三方**”的表，工程内置校验：

| 事件/字段 | 目的（Purpose） | 法律基础 | 存储位置 | 保留期 | 第三方/跨境 | 备注 |
|---|---|---|---|---|---|---|
| signup.email | 账号创建 | 合同 | users.email | 3年不活跃删 | 无 | 必填 |
| page_view | 分析 | 同意(analytics) | analytics.page | 13个月 | Amplitude（SCC） | GPC=on 时禁 |
| purchase.amount | 结算 | 合同 | orders | 5年 | 结算商（DPA） | 最小化到分币 |

> 建议把该表与**事件埋点 schema**在同仓管理，PR 触发**合规 Lint**。

---

## 4) 同意管理（CMP）与 GPC 🌐
### 4.1 策略
- **必要类**（会话、登录、购物车）→ 可直接启用；  
- **分析/营销/个性化** → 在同意（或 CCPA 退出后）才加载；  
- **UI**：清晰分类开关 + 链接到隐私政策 + “全部接受/仅必要/自定义”。  
- **GPC**：当检测到 Global Privacy Control 信号时，默认视为**拒绝出售/共享**与**拒绝跟踪**（适配 CCPA/部分地区政策）。

### 4.2 代码示例：延迟加载与 GPC
```ts
// consent.ts - 统一读取/写入同意与GPC
type Consent = { necessary: true; analytics?: boolean; ads?: boolean; personalize?: boolean; version: string; ts: number };
export async function getConsent(): Promise<Consent> {
  const gpc = (navigator as any).globalPrivacyControl === true;
  const raw = localStorage.getItem('__consent');
  const base = { necessary: true, analytics: !gpc && false, ads: !gpc && false, personalize: !gpc && false, version: '1.3.0', ts: Date.now() };
  return raw ? { ...base, ...JSON.parse(raw) } : base;
}
export async function setConsent(c: Partial<Consent>) {
  const merged = { ...(await getConsent()), ...c, ts: Date.now() };
  localStorage.setItem('__consent', JSON.stringify(merged));
  return merged;
}
```

```ts
// loader.ts - 在同意前禁用非必要脚本
import { getConsent } from './consent';
(async () => {
  const c = await getConsent();
  if (c.analytics) {
    await import('./integrations/analytics'); // 动态加载
  }
  if (c.ads) {
    await import('./integrations/ads');
  }
})();
```

> SSR/Edge 侧同样需要根据 Cookie/Region 做**地理分流**与**脚本注入控制**（如 `nonce` + CSP）。

---

## 5) 数据主体请求（DSR/DSAR）🧑‍⚖️
**必须提供**访问、导出、删除、纠正、限制处理、反对处理（GDPR）；**拒绝出售/分享**与**限制敏感信息**（CCPA/CPRA）；**复制、撤回、解释**（PIPL）。

### 5.1 流程（工程落地）
1. **验证身份**（邮箱链接 / 已登录二次确认 / WebAuthn）。  
2. **路由到数据域**（用户、订单、日志、第三方）。  
3. **组装导出包**（JSON/CSV + 解释说明），删除请求需处理**冷/热存**、备份与延迟队列。  
4. **审计日志**：请求人、动作、范围、完成时间、处理人、结果。

### 5.2 API 轮廓（示意）
```http
POST /privacy/requests
{ "type": "ACCESS|ERASURE|RECTIFY|OPTOUT_SALE", "subject": { "userId": "...", "email": "..." }, "scope": ["orders","profile","tracking"] }

GET  /privacy/requests/:id/status
```

---

## 6) 第三方与跨境 🌍
- **与第三方签 DPA/合同**：明确角色、目的、类别、保留期、分处理者、违约责任。  
- **跨境传输**：  
  - GDPR：**SCC** + 传输影响评估（TIA）；  
  - PIPL：**安全评估 / 认证 / 标准合同**（按数据量与性质适用）。  
- **分类出境**：日志/分析尽量**去标识化**或聚合后再传；必要时做**区域边缘处理**再出境。

---

## 7) 隐私 by design：工程策略 🛠️
- **数据最小化**：字段默认黑名单，**白名单加法**引入。  
- **默认关闭**：非必要追踪与个性化默认 off。  
- **差分隐私/K-匿名**：统计口径聚合后再上报（阈值低于 K 不上报）。  
- **去标识化**：哈希（加盐）、分桶、模糊化（精度降级的定位/时间）。  
- **保留与删除**：为每类数据设置 TTL；到期**自动清理**（Job + 审计）。  
- **密钥轮换**：KMS/环境分层，按季度/半年度轮换；访问控制最小化。  
- **泄露应急**：分级、封堵、取证、通报（GDPR 通常 72h 内告警监管），用户通知模板预置。

---

## 8) Cookie / SDK 实操 🍪
- **分类**：`necessary / analytics / ads / personalize`；Cookie 打上 `SameSite`、`Secure`、`HttpOnly`（如会话）。  
- **Banner & 偏好中心**：可撤回、可细分、记录版本。  
- **多框架**：Next/Nuxt/Astro 在 SSR 阶段根据同意与地区**注入/剔除**脚本标签。  
- **CSP**：对三方脚本配白名单与 `nonce`；慎用 `unsafe-inline`。  
- **GPC**：若 `navigator.globalPrivacyControl === true` → **强制禁用广告/销售/分享**路径。

---

## 9) 反模式与纠偏 🧨
| 反模式 | 症状 | 纠偏 |
|---|---|---|
| 一上来就打埋点/加载 SDK | GPC/同意都无视 | **先拦后放** + GPC |
| “同意”一次包治百病 | 无可撤回、无版本 | 偏好中心 + 版本化 + 审计 |
| 数据无限期保存 | 法务风险/成本爆炸 | **TTL/归档/删除**流水线 |
| 模糊“出售/共享” | CCPA 罚点 | 清晰 “Do Not Sell/Share” 开关与路由 |
| 跨境直接传原始日志 | 出境风险高 | 区域处理 + 去标识/聚合 + 合同 |
| 口头合规 | 审计吊打 | **自动化证据**：同意记录、DSR 处理日志、策略版本 |

---

## 10) 验收清单 ✅
- [ ] 事件/字段完成 **ROPA 数据盘点**，含目的/基础/保留/第三方。  
- [ ] 非必要追踪与 SDK **在同意前不加载**；支持 **GPC**。  
- [ ] 提供 **DSR API** 与前台入口（访问/导出/删除/纠正/拒绝出售与分享）。  
- [ ] 与第三方签署 **DPA/合同**；跨境路径具备 **SCC/标准合同/评估**证据。  
- [ ] 所有同意与策略 **版本化，可审计**；撤回后**生效路径**清晰。  
- [ ] 数据 **TTL 自动清理** 与泄露应急演练（含 72h 通报流程）已通过。  

---

## 11) 练习 🏋️
1. 为现有埋点体系补充 **purpose + legalBasis + ttl** 字段，并在构建期做 Lint。  
2. 为首页接入 **GPC + 同意延迟加载**，验证 Lighthouse 与隐私扫描器评分。  
3. 完成一条 **DSR 端到端**演练：创建 → 导出/删除 → 审计记录与回执。  
4. 梳理第三方列表，补上 **DPA/合同与跨境文档**，未通过者在代码层禁用。  

---

## 12) 文案模板片段（可直接抄改）📝
- **Banner 一行版**：  
  “我们仅使用必要 Cookie。经你同意，我们会使用分析与个性化 Cookie。你可随时在‘隐私设置’中更改。**拒绝**将不影响核心功能。”
- **GPC 提示**：  
  “检测到浏览器的 Global Privacy Control，已为你关闭广告与分享类追踪。”
- **DSR 回执**：  
  “我们已收到你的请求（编号：#{{id}}）。我们将在法定时限内处理，并通过 {{email}} 通知结果。”

---

**小结**：把**盘点 → 最小化 → 同意/GPC → 权利接口 → 第三方与跨境 → 留痕与预案**这六步固化进工程与 CI，你的应用就从“合不合规看运气”，变成“合规是一种默认状态”。🚦
