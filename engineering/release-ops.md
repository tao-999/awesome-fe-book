# 12.2 ç‰ˆæœ¬å›æ»š / ç°åº¦ / Feature Flags ğŸ”ğŸŒ—ğŸ³ï¸

æœ¬ç« ç›®æ ‡ï¼šæŠŠ**ä¸Šçº¿**ä»â€œæ‚¬å´–è·³æ°´â€æ”¹æˆâ€œæœ‰æŠ¤æ çš„å¡é“â€ã€‚ä¸‰ä»¶å¥—ï¼š
- **å›æ»š**ï¼ˆRollbackï¼‰ï¼šé‡é™©**å¿«é€Ÿæ¢å¤**ä¸Šä¸€ç¨³å®šç‰ˆæœ¬ã€‚
- **ç°åº¦**ï¼ˆCanary/Blue-Green/Ringï¼‰ï¼š**å°æµé‡è¯•æ°´**ï¼Œçœ‹æŒ‡æ ‡å†æ”¾å¤§ã€‚
- **Feature Flags**ï¼ˆç‰¹æ€§å¼€å…³ï¼‰ï¼š**ä»£ç å·²åˆå¹¶ï¼Œè¡Œä¸ºå¯æ§**ï¼Œéšæ—¶å¼€/å…³/æŒ‰äººç¾¤æŠ•æ”¾ã€‚

---

## 0) å¿ƒæ™ºå›¾ï¼ˆå…ˆå®šè°ƒï¼‰
- **å…ˆå¯å›æ»šï¼Œåæ•¢ç°åº¦**ï¼šæ²¡æœ‰å¯å›æ»šçš„å‘å¸ƒ = ç”Ÿäº§è‡ªæ€ã€‚  
- **åº¦é‡é©±åŠ¨**ï¼šä¸€åˆ‡æ”¾é‡/å›æ»šå†³ç­–ç”±æŒ‡æ ‡è¯´è¯ï¼ˆé”™è¯¯ç‡ã€å»¶è¿Ÿã€è½¬åŒ–ã€å´©æºƒç‡ï¼‰ã€‚  
- **å¹‚ç­‰ä¸åŸå­**ï¼šå‘å¸ƒ/å›æ»šåº”åŸå­åŒ–ï¼ˆCDN åŸå­åˆ‡æ¢ã€K8s å£°æ˜å¼ã€å¯é‡å¤æ‰§è¡Œï¼‰ã€‚  
- **å¼€å…³ä¸ç­‰äºå®‰å…¨æ§åˆ¶**ï¼šFeature Flag ä¸æ˜¯æƒé™ç³»ç»Ÿï¼Œ**é‰´æƒåœ¨åç«¯**ã€‚

---

## 1) å¿«é€Ÿå›æ»šï¼ˆä¸åŒå½¢æ€ï¼‰âš¡

### 1.1 Web å‰ç«¯ï¼ˆé™æ€ç«™/SPAï¼‰
- **å†…å®¹å¯»å€/ä¸å¯å˜äº§ç‰©**ï¼šæ„å»ºäº§ç‰©æŒ‰å“ˆå¸Œå‘½åï¼ˆ`main.[hash].js`ï¼‰ï¼Œ**æ¯æ¬¡éƒ¨ç½²éƒ½å¯è¿½æº¯**ã€‚  
- **åŸå­åˆ‡æ¢**ï¼šç”¨â€œ**å½“å‰ç‰ˆæœ¬æŒ‡é’ˆ**â€ï¼ˆaliasï¼‰æŒ‡å‘æŸä¸ªæ„å»ºï¼š
  - Vercelï¼š`vercel --prod` éƒ¨ç½²å¹¶å¯åœ¨ UI/CLI é€‰å›ä¸Šä¸€ç‰ˆã€‚  
  - Netlifyï¼š`netlify deploy --prod --dir=dist`ï¼Œå¯åœ¨ **Deploys** é‡Œ **Rollback**ã€‚  
  - Cloudflare Pagesï¼šæ¯æ¬¡ build éƒ½æ˜¯ç‹¬ç«‹ç‰ˆæœ¬ï¼Œåˆ‡å›æ—§ build å³å›æ»šã€‚  
- **ç¼“å­˜ç­–ç•¥**ï¼šHTML `no-cache` + èµ„äº§ `immutable, max-age=31536000`ï¼Œé¿å…â€œæ—§ HTML + æ–° JSâ€çš„æ’•è£‚ã€‚  
- **Service Worker**ï¼šé»˜è®¤**ä¸å¼ºæ›´**ã€‚æä¾›ã€Œæœ‰æ–°ç‰ˆæœ¬ï¼Œç‚¹å‡»åˆ·æ–°ã€æç¤ºï¼Œæ¯” `skipWaiting()` å¼ºè¡Œåˆ‡æ¢æ›´å®‰å…¨ã€‚

### 1.2 Node/BFF/åç«¯
- **è“ç»¿ï¼ˆBlue-Greenï¼‰**ï¼šä¸¤ç»„ç¯å¢ƒåŒæ—¶å­˜åœ¨ï¼Œ**åˆ‡æµé‡**è€Œéé‡éƒ¨ç½²ã€‚  
- **K8s å›æ»š**ï¼š  
  ```bash
  kubectl rollout undo deploy web-api --to-revision=5
  kubectl rollout status deploy web-api
  ```
- **æ•°æ®åº“å˜æ›´**ï¼šéµå¾ª **Expand â†’ Migrate â†’ Contract** ä¸‰æ­¥ï¼ˆè§ Â§4ï¼‰ã€‚**æ•°æ®åº“ä¸å¯å›æ»š**æ˜¯äº‹æ•…ä¹‹æºã€‚

### 1.3 ç§»åŠ¨ç«¯
- åº”ç”¨å•†åº—ç‰ˆæœ¬æ— æ³•ç«‹åˆ»å›æ»š â†’ **è¿œç¨‹é…ç½®/Feature Flag** åš **Kill-Switch**ï¼ˆç´§æ€¥å…³é—­æ–°åŠŸèƒ½æˆ–é™çº§ç­–ç•¥ï¼‰ã€‚  
- åˆ†é˜¶æ®µå‘å¸ƒï¼ˆStore åˆ†æµï¼‰+ å´©æºƒç‡é˜ˆå€¼è§¦å‘åœæ›´ã€‚

---

## 2) ç°åº¦å‘å¸ƒï¼ˆCanary / Blue-Green / Ringï¼‰ğŸŒ—

### 2.1 ç­–ç•¥å¯¹æ¯”
| ç­–ç•¥ | è¯´æ˜ | é€‚ç”¨ |
|---|---|---|
| **Canary** | å°æ¯”ä¾‹æµé‡ä¸Šæ–°ç‰ˆæœ¬ï¼ŒæŒ‡æ ‡è¿‡çº¿é€æ­¥æ”¾å¤§ | Web/API å¸¸ç”¨ |
| **Blue-Green** | ä¸¤å¥—ç¯å¢ƒï¼Œåˆ‡æ¢è·¯ç”±æŒ‡é’ˆ | å¤§æ”¹åŠ¨ã€é›¶åœæœº |
| **Ring/Rolling** | åˆ†æ‰¹æŒ‰åŒºåŸŸ/ç”¨æˆ·ç»„æ‰©æ•£ | å¤§ä½“é‡ã€å¤šåœ°åŸŸ |

### 2.2 K8sï¼ˆIstio æƒé‡è·¯ç”±ç¤ºä¾‹ï¼‰
```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata: { name: web }
spec:
  hosts: ["web.example.com"]
  http:
    - route:
        - destination: { host: web, subset: v2 }
          weight: 10     # 10% â†’ 25% â†’ 50% â†’ 100%
        - destination: { host: web, subset: v1 }
          weight: 90
```

### 2.3 NGINX Ingress Canaryï¼ˆç®€ç‰ˆï¼‰
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: web
  annotations:
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-weight: "20"
```

### 2.4 æŒ‡æ ‡é—¸é—¨ï¼ˆè‡ªåŠ¨åŒ–æ”¾é‡/å›æ»šï¼‰
- è®¾å®š **SLO å®ˆé—¨**ï¼š5xx ç‡ã€P95/P99 å»¶è¿Ÿã€å‰ç«¯é”™è¯¯ç‡ã€æ ¸å¿ƒè½¬åŒ–ã€‚  
- è¯„ä¼°çª—å£ï¼ˆå¦‚ 10â€“15 åˆ†é’Ÿï¼‰ç¨³å®šåå†æ”¾é‡ï¼›ä»»ä¸€é˜ˆå€¼è¶Šç•Œ â†’ **è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€æƒé‡**ã€‚

---

## 3) Feature Flagsï¼ˆç‰¹æ€§å¼€å…³ï¼‰ğŸ³ï¸

### 3.1 ç±»å‹
- **Release Flag**ï¼šæ§åˆ¶åŠŸèƒ½ä¸Šçº¿/ç°åº¦/å›æ»šã€‚  
- **Experiment Flag**ï¼šA/B / å¤šè‡‚ banditã€‚  
- **Ops Flag**ï¼šé™æµã€é™çº§ã€Kill-Switchã€‚  
- **Permission Flag**ï¼šæŒ‰ç§Ÿæˆ·/è§’è‰²å¼€å…³ï¼ˆä»éœ€æœåŠ¡ç«¯é‰´æƒï¼‰ã€‚

### 3.2 è®¾è®¡è¦ç‚¹
- **é»˜è®¤å®‰å…¨**ï¼šæœªå–åˆ°é…ç½®æ—¶èµ°**ä¿å®ˆé»˜è®¤å€¼**ã€‚  
- **ä¸€è‡´æ€§**ï¼šç”¨ **ç¨³å®šå“ˆå¸Œ**ï¼ˆuserId/tenantIdï¼‰åšæ¡¶ï¼Œé¿å…ç”¨æˆ·åˆ·æ–°è·³æ¡¶ã€‚  
- **æœ€å°éšç§**ï¼šFlag è¯„ä¼°å°½é‡åœ¨**æœåŠ¡ç«¯**ï¼ˆæˆ– Edgeï¼‰ï¼Œå®¢æˆ·ç«¯ä»…æ¥æ”¶**ä¸è‡ªèº«ç›¸å…³**çš„åˆ¤å®šç»“æœã€‚  
- **å¯è§‚æµ‹**ï¼šæ¯æ¬¡è¯„ä¼°**æ‰“æ›å…‰æ—¥å¿—**ï¼ˆflag åã€å˜ä½“ã€ç”¨æˆ·é”®ï¼‰ï¼Œä¾›å®éªŒä¸å›æ»šå†³ç­–ä½¿ç”¨ã€‚  
- **ç”Ÿå‘½å‘¨æœŸ**ï¼šåˆ›å»ºâ†’ä¸Šçº¿â†’æ”¾é‡â†’**æ¸…ç†æ­»æ——**ï¼ˆå€ºåŠ¡ï¼‰ã€‚

### 3.3 æç®€å®ç°ï¼ˆTypeScriptï¼Œæ¼”ç¤ºæ¦‚å¿µï¼‰
```ts
// flags.ts
export type Variant = 'on' | 'off' | 'A' | 'B';
export type Context = { userId?: string; tenantId?: string; [k: string]: unknown };

export interface Provider {
  get(flag: string, ctx: Context): Variant | undefined;
}

export class InMemoryProvider implements Provider {
  constructor(private store: Record<string, any>) {}
  get(flag: string, ctx: Context) {
    const def = this.store[flag];
    if (!def) return undefined;
    if (def.percentage != null) {
      const key = String(ctx.userId ?? ctx.tenantId ?? 'anon');
      const bucket = (hash(key + flag) % 100);
      return bucket < def.percentage ? 'on' : 'off';
    }
    if (def.variants) {
      const key = String(ctx.userId ?? 'anon');
      const bucket = hash(key + flag) % 100;
      let acc = 0;
      for (const [name, pct] of Object.entries<number>(def.variants)) {
        acc += pct;
        if (bucket < acc) return name as Variant;
      }
    }
    return def.default ?? 'off';
  }
}

function hash(s: string) { // ä¸€è‡´æ€§å“ˆå¸Œï¼ˆæ¼”ç¤ºï¼‰
  let h = 2166136261;
  for (let i = 0; i < s.length; i++) h = (h ^ s.charCodeAt(i)) * 16777619;
  return Math.abs(h >>> 0);
}

// ä½¿ç”¨
const provider = new InMemoryProvider({
  'checkout-new': { percentage: 10, default: 'off' },      // 10% ç°åº¦
  'search-algo': { variants: { A: 50, B: 50 }, default: 'A' }
});

export function isOn(flag: string, ctx: Context) {
  return provider.get(flag, ctx) === 'on';
}
```

> ç”Ÿäº§å»ºè®®ï¼šé‡‡ç”¨ **OpenFeature** æ ‡å‡†æˆ–æ‰˜ç®¡æœåŠ¡ï¼ˆLaunchDarklyã€Unleashã€Flagdã€ConfigCat ç­‰ï¼‰ï¼Œå…·å¤‡å®¡è®¡ã€ç›®æ ‡äººç¾¤ã€å¯è§†åŒ–ä¸ SDKã€‚

### 3.4 å‰ç«¯ä½¿ç”¨ï¼ˆReact ä¾‹ï¼‰
```tsx
{isOn('checkout-new', { userId }) ? <NewCheckout /> : <LegacyCheckout />}
```

---

## 4) æ•°æ®åº“ä¸å›æ»šï¼ˆ**Expand â†’ Migrate â†’ Contract**ï¼‰ğŸ§±

1. **Expand**ï¼šå…ˆ**åŠ åˆ—/è¡¨/ç´¢å¼•**ï¼Œæ–°è€ä»£ç éƒ½èƒ½è¯»å†™ã€‚  
2. **Migrate**ï¼šåå°è¿ç§»æ•°æ®ï¼ˆå¹‚ç­‰ã€å¯é‡è¯•ï¼‰ï¼›åŒå†™/è¯»æ—¶**éªŒè¯ä¸€è‡´æ€§**ã€‚  
3. **Contract**ï¼šç¡®è®¤æ— è€è¯»å†™å**ç§»é™¤æ—§å­—æ®µ**ã€‚  

> ä»»ä½•éœ€è¦ **å›æ»š** çš„å˜æ›´ï¼Œéƒ½å¿…é¡»ç¡®ä¿æ—§ç‰ˆæœ¬åœ¨ Expand é˜¶æ®µä»å¯å·¥ä½œï¼ˆé¿å…â€œä¸å¯å›æ»šçš„ DDLâ€ï¼‰ã€‚

---

## 5) è‡ªåŠ¨åŒ–æ”¾é‡ä¸ä¸€é”®å›æ»šï¼ˆCI/CD é…ç½®ç‰‡æ®µï¼‰ğŸ¤–

### 5.1 GitHub Actionsï¼šé˜¶æ®µæ”¾é‡ï¼ˆä¼ªä»£ç ï¼‰
```yaml
jobs:
  canary:
    steps:
      - run: kubectl apply -f k8s/virtualservice-10.yaml
      - run: node scripts/wait-slo-ok.js --window=15m --p95<300 --err<0.5%
      - run: kubectl apply -f k8s/virtualservice-25.yaml
      - run: node scripts/wait-slo-ok.js --window=15m
      - run: kubectl apply -f k8s/virtualservice-50.yaml
  rollback_on_fail:
    if: failure()
    steps:
      - run: kubectl apply -f k8s/virtualservice-0.yaml   # å…¨é‡å›é€€åˆ° v1
```

### 5.2 ç°åº¦ä¸å¼€å…³è”åŠ¨
- ç°åº¦é˜¶æ®µ**åŒæ­¥**å¼€ `release flag`ï¼Œä¸€æ—¦æŒ‡æ ‡è¶Šç•Œï¼Œæµæ°´çº¿è‡ªåŠ¨ï¼š**å…³ Flag â†’ é™æƒé‡/å›æ»š**ã€‚  
- **å¹‚ç­‰è„šæœ¬**ï¼šå¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´ï¼›å¤±è´¥å¯é‡è¯•ã€‚

---

## 6) è¿è¥ä¸å®éªŒ ğŸ“Š
- **æ›å…‰/ç‚¹å‡»/è½¬åŒ–**æ‰“ç‚¹ä¸ flag å˜ä½“**å¼ºå…³è”**ï¼›ä¸åˆå¹¶æ•°æ®ä¼šå¯¼è‡´é”™åˆ¤ã€‚  
- **æ ·æœ¬å®ˆæ’**ï¼šåˆ†æ¡¶åä¸å¾—å†æŒ‰ç”¨æˆ·å±æ€§â€œåç½®ç­›é€‰â€ï¼Œå¦åˆ™å®éªŒå¤±çœŸã€‚  
- **åœç•™æ—¶é—´**ï¼šç»™å®éªŒè¶³å¤Ÿæ—¶é•¿è¦†ç›–å³°è°·å‘¨æœŸï¼›é¿å…åªçœ‹çŸ­æœŸå™ªå£°ã€‚

---

## 7) å®‰å…¨ä¸åˆè§„ ğŸ›¡ï¸
- **ä¸è¦æŠŠæ•æ„Ÿé€»è¾‘ä»…é  Flag éšè—åœ¨å‰ç«¯**ï¼›æœåŠ¡ç«¯ä»éœ€**ç¡¬é‰´æƒ**ã€‚  
- Flag å/é”®ä¸æ³„éœ²æœºå¯†ï¼ˆæ¯”å¦‚ã€Œ`flag-enable-secret-experiment`ã€ï¼‰ã€‚  
- å˜ä½“è¯„ä¼°æ—¥å¿—**è„±æ•**ï¼Œéµå®ˆéšç§æ³•è§„ï¼ˆGDPR/CCPA ç­‰ï¼‰ã€‚

---

## 8) åæ¨¡å¼ä¸çº å ğŸ§¨

| åæ¨¡å¼ | ç—‡çŠ¶ | çº å |
|---|---|---|
| â€œä¸€åˆ€åˆ‡å…¨é‡ä¸Šâ€ | å¤§æ•…éšœ | å…ˆ 5â€“10% Canaryï¼ŒæŒ‡æ ‡ OK å†æ”¾å¤§ |
| å‰ç«¯å¼ºåˆ¶ SW ç«‹æ›´ | ç™½å±/èµ„æºé”™ç‰ˆ | å¼¹çª—æç¤ºåˆ·æ–°ï¼›åŸå­åˆ‡æ¢ + ç¼“å­˜ç­–ç•¥ |
| DB ç›´æ”¹/åˆ åˆ— | æ— æ³•å›æ»š | **Expand/Migrate/Contract** |
| Flag æ— é»˜è®¤å€¼ | ç¦»çº¿å°±ç‚¸ | é»˜è®¤ **off**ï¼›å¤±è´¥å®¹å¿å¹¶é™çº§ |
| æ°¸ä¹…ä¸æ¸…æ—— | ä»£ç å€ºå †ç§¯ | ä¸ºæ¯ä¸ªæ——è®¾ **åˆ°æœŸæ¸…ç†**ä»»åŠ¡ |
| æŠŠ Flag å½“æƒé™ | è¶Šæƒé£é™© | æƒé™åœ¨åç«¯ï¼ŒFlag ä»…æ§åˆ¶ UI/è¡Œä¸º |
| ç°åº¦æ— æŒ‡æ ‡ | æ”¾é‡å‡­æ„Ÿè§‰ | å®šä¹‰ **SLO é˜ˆå€¼** + è‡ªåŠ¨åŒ–é—¸é—¨ |

---

## 9) æäº¤å‰æ£€æŸ¥æ¸…å• âœ…
- [ ] æœ¬æ¬¡å˜æ›´å…·å¤‡**å•é”®å›æ»š**ï¼ˆä¸Šä¸€ç‰ˆæœ¬å¯ç›´æ¥åˆ‡å›ï¼‰ã€‚  
- [ ] CDN/ç¼“å­˜ç­–ç•¥ä¸æ„å»ºäº§ç‰©**åŸå­åˆ‡æ¢**æ ¡éªŒé€šè¿‡ã€‚  
- [ ] ç°åº¦è®¡åˆ’ï¼šé˜¶æ®µã€é˜ˆå€¼ã€è§‚å¯Ÿçª—å£ã€å›æ»šæ¡ä»¶å·²é…ç½®ã€‚  
- [ ] ç›¸å…³ Feature Flag å·²åˆ›å»ºï¼šé»˜è®¤å€¼ã€å®‰å…¨å›é€€ã€å®¡è®¡è®°å½•ã€‚  
- [ ] æ•°æ®åº“å˜æ›´æŒ‰ **Expand/Migrate/Contract** æ‰§è¡Œï¼Œè¿ç§»è„šæœ¬å¹‚ç­‰ã€‚  
- [ ] è§‚æµ‹é¡¹ï¼ˆé”™è¯¯ç‡ã€å»¶è¿Ÿã€å…³é”®ä¸šåŠ¡è½¬åŒ–ï¼‰å·²åœ¨çœ‹æ¿ä¸æŠ¥è­¦ä¸­ã€‚  
- [ ] å›æ»šå‰§æœ¬ï¼ˆRunbookï¼‰åœ¨ README/å€¼ç­æ‰‹å†Œï¼Œå›¢é˜Ÿæ¼”ç»ƒè¿‡ä¸€æ¬¡ã€‚

---

## 10) ç»ƒä¹  ğŸ‹ï¸
1. ä¸ºã€Œæœç´¢æ”¹é€ ã€åŠ ä¸€ä¸ª **release flag**ï¼ŒæŒ‰ 10%â†’25%â†’50% æ”¾é‡ï¼›è¶…è¿‡â€œé”™è¯¯ç‡ 0.5%â€æˆ–â€œP95>300msâ€è‡ªåŠ¨å›æ»šã€‚  
2. ç»™ã€Œç»“ç®—é¡µã€åšä¸€æ¬¡ **Blue-Green** å‘å¸ƒæ¼”ç»ƒï¼Œå¹¶åœ¨ CDN ä¸ŠéªŒè¯é™æ€èµ„æº**åŸå­åˆ‡æ¢**ã€‚  
3. æŒ‰ **Expand/Migrate/Contract** ä¸º `orders` å¢åŠ  `country` å­—æ®µï¼Œå®ŒæˆåŒå†™è¿ç§»å¹¶æ¸…åˆ—å›æ”¶ã€‚  

---

**å°ç»“**ï¼š**å›æ»š**ä¿å‘½ã€**ç°åº¦**è¯•æ°´ã€**Flag**æ§èŠ‚å¥ã€‚ä¸‰è€…åä½œï¼ŒæŠŠâ€œä¸Šçº¿â€è¿™ä»¶äº‹ä»ä¸€æ¬¡æ€§å†’é™©å˜æˆå¯åº¦é‡ã€å¯å›é€€ã€å¯ä¼˜åŒ–çš„å·¥ç¨‹è¿‡ç¨‹ã€‚ğŸš€
